pkgname="carbonio-nginx"
pkgver="1.28.0" # renovate: datasource=github-tags depName=nginx/nginx extractVersion=^release-(?<version>.+)$ versioning=semver allowedVersions=/^1\.(2[0-9]*[02468]|[3-9][0-9]*[02468])\./
pkgrel="2"
pkgdesc="Lightweight HTTP server and IMAP/POP3 proxy server"
arch=('x86_64')
maintainer="Zextras <packages@zextras.com>"
url="https://github.com/zextras"
license=('BSD-2-Clause')
depends__apt=(
  "carbonio-cyrus-sasl"
  "carbonio-openssl"
  "libbrotli1"
  "libcap2-bin"
  "libpcre3"
  "zlib1g"
)
makedepends__apt=(
  "git"
  "libbrotli-dev"
  "libcap2-bin"
  "libpcre3-dev"
  "zlib1g-dev"
)
depends__yum=(
  "carbonio-cyrus-sasl"
  "carbonio-openssl"
  "brotli"
  "libcap"
  "pcre"
  "zlib"
)
makedepends__yum=(
  "brotli-devel"
  "git"
  "libcap"
  "pcre-devel"
  "zlib-devel"
)
section="utils"
priority="optional"
source=(
  "https://nginx.org/download/nginx-${pkgver}.tar.gz"
  "nginx-brotli::git+https://github.com/google/ngx_brotli#commit=a71f9312c2deb28875acc7bacfdd5695a111aa53"
  "modules::git+https://github.com/zextras/carbonio-nginx-modules#commit=e62d730a1f5f23494fba7f0a45d3271c335fae6f"
  "${pkgname}.path"
  "${pkgname}.service"
  "${pkgname}-reload.service"
  "${pkgname}-${pkgver}.patch"
  "systemd-tmpfile.conf"
)
sha256sums=(
  'c6b5c6b086c0df9d3ca3ff5e084c1d0ef909e6038279c71c1c3e985f576ff76a'
  'SKIP'
  'SKIP'
  'd53cbfabd4db6640b4c882d9115db8d36f4e7122a4781ae5c9a58d9b046a7d07'
  '3a810357648faed268e83fe005bbfcba4925a236f91db1ee47728459021d2a36'
  '00a860ca81736752ec683578c70247126415dd4821f8788425fd9749290b4a05'
  'fc1f424ddcceca647d2eb9e1d1f129f4fb09f42f74c7c0bbf818dadc5bb0509f'
  '0d9bf766db1f5e64bd6f8766f22735f7af5cffed4759e15b0d99dd9da4ce9ee2'
)
prepare() {
  cd "${srcdir}/nginx-brotli"
  git submodule update --init --recursive
}

build() {

  export LDFLAGS="-Wl,-rpath,/opt/zextras/common/lib -L/opt/zextras/common/lib"
  export CFLAGS="-g -O2 -fdebug-prefix-map=/etc=. -fstack-protector-strong"

  cd "${srcdir}/nginx-${pkgver}"
  patch -Np1 -i "${srcdir}/${pkgname}-${pkgver}.patch"

  ./configure \
    --add-module="${srcdir}/nginx-brotli" \
    --add-module="${srcdir}/modules/http/sso" \
    --add-module="${srcdir}/modules/http/upstreamzmauth" \
    --add-module="${srcdir}/modules/mail/zmauth" \
    --add-module="${srcdir}/modules/mail/throttle" \
    --error-log-path=/opt/zextras/log/nginx.log \
    --http-log-path=/opt/zextras/log/nginx.access.log \
    --http-client-body-temp-path=/opt/zextras/data/tmp/nginx/client \
    --http-proxy-temp-path=/opt/zextras/data/tmp/nginx/proxy \
    --http-fastcgi-temp-path=/opt/zextras/data/tmp/nginx/fastcgi \
    --pid-path=/run/carbonio/nginx.pid \
    --prefix=/opt/zextras/common \
    --with-cc-opt="-g -I/opt/zextras/common/include" \
    --with-ld-opt="-Wl,-rpath,/opt/zextras/common/lib -L/opt/zextras/common/lib" \
    --with-http_ssl_module \
    --with-http_stub_status_module \
    --with-pcre \
    --with-http_addition_module \
    --with-http_auth_request_module \
    --with-http_degradation_module \
    --with-http_gunzip_module \
    --with-http_gzip_static_module \
    --with-http_secure_link_module \
    --with-http_slice_module \
    --with-http_ssl_module \
    --with-http_stub_status_module \
    --with-http_sub_module \
    --with-http_v2_module \
    --with-stream \
    --with-stream_ssl_module \
    --with-stream_ssl_preread_module \
    --with-threads \
    --with-mail \
    --with-mail-sasl \
    --with-mail_ssl_module \
    --without-http_scgi_module \
    --without-http_uwsgi_module
  make -j16
}

package() {
  cd "${srcdir}/nginx-${pkgver}"
  make DESTDIR="${pkgdir}" install
  mkdir -p "${pkgdir}"/opt/zextras/data/nginx
  mv "${pkgdir}"/opt/zextras/common/html "${pkgdir}"/opt/zextras/data/nginx/

  # systemd unit
  install -D -m 644 "${srcdir}/${pkgname}.service" \
    "${pkgdir}/usr/lib/systemd/system/${pkgname}.service"
  install -D -m 644 "${srcdir}/${pkgname}-reload.service" \
    "${pkgdir}/usr/lib/systemd/system/${pkgname}-reload.service"
  install -D -m 644 "${srcdir}/${pkgname}.path" \
    "${pkgdir}/usr/lib/systemd/system/${pkgname}.path"

  # systemd tmpfiles.d configuration
  install -D -m 644 "${srcdir}/systemd-tmpfile.conf" \
    "${pkgdir}/usr/lib/tmpfiles.d/${pkgname}.conf"

  rm -rf "${pkgdir}/run"
}

postinst__apt() {
  # Apply tmpfiles.d configuration
  systemd-tmpfiles --create /usr/lib/tmpfiles.d/carbonio-nginx.conf >/dev/null 2>&1 || :

  # Set permissions and capabilities on nginx binary
  # Note: On fresh install, zextras group may not exist yet (created by carbonio-core).
  # In that case, carbonio-core's postinst will set these permissions.
  # On upgrade/reinstall, zextras exists and we can set permissions here.
  if getent group zextras >/dev/null 2>&1; then
    # Note: chmod resets capabilities, so setcap must run after chmod
    chown root:zextras /opt/zextras/common/sbin/nginx
    chmod 750 /opt/zextras/common/sbin/nginx
    setcap CAP_NET_BIND_SERVICE=+ep /opt/zextras/common/sbin/nginx
  fi
}

postinst__yum() {
  # Apply tmpfiles.d configuration
  systemd-tmpfiles --create /usr/lib/tmpfiles.d/carbonio-nginx.conf >/dev/null 2>&1 || :

  # Set permissions and capabilities on nginx binary
  # Note: On fresh install, zextras group may not exist yet (created by carbonio-core).
  # In that case, carbonio-core's postinst will set these permissions.
  # On upgrade/reinstall, zextras exists and we can set permissions here.
  if getent group zextras >/dev/null 2>&1; then
    # Note: chmod resets capabilities, so setcap must run after chmod
    chown root:zextras /opt/zextras/common/sbin/nginx
    chmod 750 /opt/zextras/common/sbin/nginx
    setcap CAP_NET_BIND_SERVICE=+ep /opt/zextras/common/sbin/nginx
  fi
}
