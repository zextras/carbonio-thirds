targets=(
  "centos"
  "ubuntu"
)
pkgname="carbonio-nginx"
pkgver="1.24.0"
pkgrel="1"
pkgdesc="Lightweight HTTP server and IMAP/POP3 proxy server"
pkgdesclong=(
  "Lightweight HTTP server and IMAP/POP3 proxy server"
)
arch="amd64"
maintainer="Zextras <packages@zextras.com>"
url="https://zextras.com"
license=("CUSTOM")
depends:apt=(
  "libbrotli1"
  "libpcre3"
  "zlib1g"
  "carbonio-cyrus-sasl"
  "carbonio-openssl"
)
makedepends:apt=(
  "libbrotli-dev"
  "libpcre3-dev"
  "zlib1g-dev"
)
depends:yum=(
  "brotli"
  "pcre"
  "zlib"
  "carbonio-cyrus-sasl"
  "carbonio-openssl"
)
makedepends:yum=(
  "brotli-devel"
  "pcre-devel"
  "zlib-devel"
)
section="utils"
priority="optional"
sources=(
  "https://nginx.org/download/nginx-${pkgver}.tar.gz"
  "https://github.com/nviennot/nginx-tcp-keepalive/archive/19755fc0e22aa7d7ac2198f78b297951d31ea1dc.tar.gz"
  "https://github.com/google/ngx_brotli/archive/v1.0.0rc/ngx_brotli-1.0.0rc.tar.gz"
  "modules.tar.gz"
  "carbonio-${pkgver}.patch"
)
hashsums=(
  "77a2541637b92a621e3ee76776c8b7b40cf6d707e69ba53a940283e30ff2f55d"
  "8b09b8eefb13d298f865ccb3563f9e2b808f7f5467b261532c47f0a2bddf2685"
  "c85cdcfd76703c95aa4204ee4c2e619aa5b075cac18f428202f65552104add3b"
  "b8d1b9c577453d195505c8e4cd195420d5876d2a3dd81480821fdbe149f038b2"
  "6ad6e961a62d20c3de164ef1b478f7317f28be434e23a136caab783580e52041"
  "2a7cf5e56b28fa4229c85120593982b88638daeec4a3729acc00a4fe581292aa"
)

build() {

  export LDFLAGS="-Wl,-rpath,/opt/zextras/common/lib -L/opt/zextras/common/lib"
  export CFLAGS="-g -O2 -fdebug-prefix-map=/etc=. -fstack-protector-strong"

  cd "${srcdir}/nginx-${pkgver}"
  patch -Np1 -i ../"carbonio-${pkgver}.patch"

  cp -r ../modules zmmodules
  cp -r ../nginx-tcp-keepalive* zmmodules/nginx-tcp-keepalive
  ./configure --prefix=/opt/zextras/common \
  --with-cc-opt="-g -I/opt/zextras/common/include" \
  --with-ld-opt="-Wl,-rpath,/opt/zextras/common/lib -L/opt/zextras/common/lib" \
  --with-http_ssl_module \
  --with-http_stub_status_module \
  --with-pcre \
  --with-http_addition_module \
  --with-http_auth_request_module \
  --with-http_degradation_module \
  --with-http_gunzip_module \
  --with-http_gzip_static_module \
  --with-http_secure_link_module \
  --with-http_slice_module \
  --with-http_ssl_module \
  --with-http_stub_status_module \
  --with-http_sub_module \
  --with-http_v2_module \
  --with-stream \
  --with-stream_ssl_module \
  --with-stream_ssl_preread_module \
  --with-threads \
  --with-mail \
  --with-mail-sasl \
  --with-mail_ssl_module \
  --error-log-path=/opt/zextras/log/nginx.log \
  --http-log-path=/opt/zextras/log/nginx.access.log \
  --http-client-body-temp-path=/opt/zextras/data/tmp/nginx/client \
  --http-proxy-temp-path=/opt/zextras/data/tmp/nginx/proxy \
  --http-fastcgi-temp-path=/opt/zextras/data/tmp/nginx/fastcgi \
  --without-http_scgi_module \
  --without-http_uwsgi_module \
  --add-module="${srcdir}"/ngx_brotli-1.0.0rc \
  --add-module=zmmodules/nginx-tcp-keepalive \
  --add-module=zmmodules/http/sso \
  --add-module=zmmodules/http/upstreamzmauth \
  --add-module=zmmodules/mail/zmauth \
  --add-module=zmmodules/mail/throttle  
  make -j16
}

package() {
  cd "${srcdir}/nginx-${pkgver}"
  make DESTDIR="${pkgdir}" install
  mkdir -p "${pkgdir}"/opt/zextras/data/nginx
  mv "${pkgdir}"/opt/zextras/common/html "${pkgdir}"/opt/zextras/data/nginx/  
}

postinst:apt() {
  if [ "$1" = "configure" ]; then
    # creating zextras group if it isn't already there
    if ! getent group zextras >/dev/null; then
      addgroup --system --force-badname --quiet zextras
    fi

    # creating zextras user if it isn't already there
    if ! getent passwd zextras >/dev/null; then
      adduser --system --force-badname --quiet \
        --ingroup zextras \
        --home /opt/zextras \
        --shell /bin/bash \
        zextras
      usermod -c "zextras user" zextras
    fi
  fi

  chown zextras:zextras /opt/zextras/log
}

postinst:yum() {
  # creating zextras group if it isn't already there
  if ! getent group zextras >/dev/null; then
    groupadd --system zextras >/dev/null
  fi
  # creating zextras user if it isn't already there
  if ! getent passwd zextras >/dev/null; then
    useradd --system \
      -g zextras \
      -d /opt/zextras \
      --shell /bin/bash \
      zextras >/dev/null
    usermod -c "zextras user" zextras
  fi

  chown zextras:zextras /opt/zextras/log
}
