targets=(
  "centos"
  "ubuntu"
)
pkgname="carbonio-clamav"
pkgver="0.103.8"
pkgrel="1"
pkgdesc="Anti-virus toolkit for Unix"
pkgdesclong=(
  "Anti-virus toolkit for Unix"
)
arch="amd64"
maintainer="Zextras <packages@zextras.com"
url="https://zextras.com"
depends:apt=(
  "carbonio-curl"
  "carbonio-libmilter"
  "carbonio-libxml2"
  "carbonio-openssl"
  "libpcre2-8-0"
  "zlib1g"
)
makedepends:apt=(
  "alien"
  "libncursesw5-dev"
  "libpcre2-dev"
  "zlib1g-dev"
)
depends:yum=(
  "carbonio-curl"
  "carbonio-libmilter"
  "carbonio-libxml2"
  "carbonio-openssl"
  "pcre2"
  "zlib"
)
makedepends:yum=(
  "alien"
  "ncurses-devel"
  "pcre2-devel"
  "zlib-devel"
)
section="utils"
priority="optional"
sources=(
  "https://www.clamav.net/downloads/production/clamav-${pkgver}.tar.gz"
  "https://download-ib01.fedoraproject.org/pub/fedora/linux/updates/37/Everything/x86_64/Packages/c/clamav-data-${pkgver}-3.fc37.noarch.rpm"
)
hashsums=(
  "6f49da6ee927936de13d359e559d3944248e3a257d40b80b6c99ebe6fe8c8c3f"
  "skip"
)

build() {
  export LDFLAGS="-Wl,-rpath,/opt/zextras/common/lib -L/opt/zextras/common/lib"
  export CPPFLAGS="-I/opt/zextras/common/include"
  cd "${srcdir}/clamav-${pkgver}"

  ./configure \
    --prefix=/opt/zextras/common \
    --libdir=/opt/zextras/common/lib \
    --with-libcurl=/opt/zextras/common \
    --with-libmilter=/opt/zextras/common \
    --with-openssl=/opt/zextras/common \
    --with-xml=/opt/zextras/common \
    --with-user=zextras \
    --with-group=zextras \
    --with-included-ltdl \
    --disable-clamav \
    --enable-milter
  make -j16
}

package() {
  cd "${srcdir}"
  alien -t "clamav-data-${pkgver}"*.noarch.rpm

  cd "${srcdir}/clamav-${pkgver}"
  make DESTDIR="${pkgdir}" install

  mkdir -p "${pkgdir}/opt/zextras/data/clamav/db"
  tar -xvf "${srcdir}/clamav-data-${pkgver}.tgz" \
    --strip-components=4 -C "${pkgdir}/opt/zextras/data/clamav/db"

  find "${pkgdir}" -name '*.a' -delete
  find "${pkgdir}" -name '*.la' -delete

  rm -rf "${pkgdir}"/usr
  rm -rf "${pkgdir}"/opt/zextras/common/bin/clamav-config
}
