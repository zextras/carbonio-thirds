targets=(
  "centos"
  "ubuntu"
)
pkgname="carbonio-clamav"
pkgver="0.103.4"
pkgrel="2"
pkgdesc="Anti-virus toolkit for Unix"
pkgdesclong=(
  "Anti-virus toolkit for Unix"
)
arch="amd64"
maintainer="Zextras <packages@zextras.com"
url="https://zextras.com"
depends=(
  "carbonio-libmilter"
  "carbonio-libxml2"
  "carbonio-mta"
  "carbonio-openssl"
  "libpcre2-8-0"
  "zlib1g"
)
makedepends:apt=(
  "libncursesw5-dev"
  "libpcre2-dev"
  "zlib1g-dev"
)
depends:yum=(
  "carbonio-libmilter"
  "carbonio-libxml2"
  "carbonio-mta"
  "carbonio-openssl"
  "pcre2"
  "zlib"
)
makedepends:yum=(
  "ncurses-devel"
  "pcre2-devel"
  "zlib-devel"
)
section="utils"
priority="optional"
sources=(
  "https://www.clamav.net/downloads/production/clamav-${pkgver}.tar.gz"
)
hashsums=(
  "def0ad15500fa6aff81d8e68b9f83aa75ee5b607a01335c1d26dbcc959932f85"
)

build() {
  export LDFLAGS="-Wl,-rpath,/opt/zextras/common/lib -L/opt/zextras/common/lib"
  export CPPFLAGS="-I/opt/zextras/common/include"
  cd "${srcdir}/clamav-${pkgver}"

  ./configure \
    --prefix=/opt/zextras/common \
    --libdir=/opt/zextras/common/lib \
    --with-libcurl=/opt/zextras/common \
    --with-libmilter=/opt/zextras/common \
    --with-openssl=/opt/zextras/common \
    --with-xml=/opt/zextras/common \
    --with-user=zextras \
    --with-group=zextras \
    --with-included-ltdl \
    --disable-clamav \
    --enable-milter
  make -j16
}

package() {
  cd "${srcdir}/clamav-${pkgver}"
  make DESTDIR="${pkgdir}" install

  find "${pkgdir}" -name '*.a' -delete
  find "${pkgdir}" -name '*.la' -delete

  rm -rf "${pkgdir}"/usr/lib/systemd
  rm -rf "${pkgdir}"/opt/zextras/common/bin/clamav-config
}
