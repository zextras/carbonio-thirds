targets=(
  "centos"
  "ubuntu"
)
pkgname="carbonio-clamav"
pkgver="1.0.1"
pkgrel="1"
pkgdesc="Anti-virus toolkit for Unix"
pkgdesclong=(
  "Anti-virus toolkit for Unix"
)
arch="amd64"
maintainer="Zextras <packages@zextras.com"
url="https://zextras.com"
depends:apt=(
  "carbonio-curl"
  "carbonio-libmilter"
  "carbonio-libxml2"
  "carbonio-openssl"
  "libjson-c4"
  "libpcre2-8-0"
  "zlib1g"
)
makedepends:apt=(
  "alien"
  "cargo"
  "check"
  "libjson-c-dev"
  "libncursesw5-dev"
  "libpcre2-dev"
  "zlib1g-dev"
)
depends:yum=(
  "carbonio-curl"
  "carbonio-libmilter"
  "carbonio-libxml2"
  "carbonio-openssl"
  "json-c"
  "pcre2"
  "zlib"
)
makedepends:yum=(
  "alien"
  "cargo"
  "check-devel"
  "json-c-devel"
  "ncurses-devel"
  "pcre2-devel"
  "zlib-devel"
)
section="utils"
priority="optional"
sources=(
  "https://www.clamav.net/downloads/production/clamav-${pkgver}.tar.gz"
  "https://dl.fedoraproject.org/pub/fedora/linux/development/rawhide/Everything/aarch64/os/Packages/c/clamav-data-${pkgver}-4.fc39.noarch.rpm"
  "carbonio-clamav"
  "carbonio-clamav-setup.sh"
  "carbonio-clamav-sidecar.service"
  "carbonio-clamav.hcl"
  "intentions.json"
  "policies.json"
  "service-protocol.json"
)
hashsums=(
  "0872dc1b82ff4cd7e8e4323faf5ee41a1f66ae80865d05429085b946355d86ee"
  "d5290e6ca19714f205bd0fdfbf2acb1cfb0c73097f8cb3b822e0dbe2d8985dad"
  "skip"
  "skip"
  "skip"
  "skip"
  "skip"
  "skip"
  "skip"
)

build() {
  export LDFLAGS="-Wl,-rpath,/opt/zextras/common/lib -L/opt/zextras/common/lib"
  export CPPFLAGS="-I/opt/zextras/common/include"
  cd "${srcdir}/clamav-${pkgver}"
  cmake . \
    -DCMAKE_INSTALL_PREFIX=/opt/zextras/common \
    -DCLAMAV_USER=zextras \
    -DCLAMAV_GROUP=zextras \
    -DENABLE_MILTER=true

  make -j16
}

package() {
  cd "${srcdir}"
  alien -t clamav-data-*.noarch.rpm

  cd "${srcdir}/clamav-${pkgver}"
  make DESTDIR="${pkgdir}" install

  mkdir -p "${pkgdir}/opt/zextras/data/clamav/db"
  tar -xvf "${srcdir}"/clamav-data-*.tgz \
    --strip-components=4 \
    -C "${pkgdir}/opt/zextras/data/clamav/db"

  find "${pkgdir}" -name '*.a' -delete
  find "${pkgdir}" -name '*.la' -delete

  rm -rf "${pkgdir}"/usr
  rm -rf "${pkgdir}"/opt/zextras/common/bin/clamav-config
  if [ -d "${pkgdir}/opt/zextras/common/lib64" ]; then
    mv "${pkgdir}/opt/zextras/common/lib64" \
      "${pkgdir}/opt/zextras/common/lib"
  fi

  # start install carbonio-clamav consul registration artifacts
  install -D -m 755 "${srcdir}/carbonio-clamav" \
    "${pkgdir}/usr/bin/carbonio-clamav"

  install -D -m 644 "${srcdir}/carbonio-clamav-sidecar.service" \
    "${pkgdir}/lib/systemd/system/carbonio-clamav-sidecar.service"

  install -D -m 644 "${srcdir}/policies.json" \
    "${pkgdir}/etc/carbonio/clamav/service-discover/policies.json"

  install -D -m 644 "${srcdir}/carbonio-clamav.hcl" \
    "${pkgdir}/etc/zextras/service-discover/carbonio-clamav.hcl"

  install -D -m 644 "${srcdir}/intentions.json" \
    "${pkgdir}/etc/carbonio/clamav/service-discover/intentions.json"

  install -D -m 644 "${srcdir}/service-protocol.json" \
    "${pkgdir}/etc/carbonio/clamav/service-discover/service-protocol.json"

  install -D -m 755 "${srcdir}/carbonio-clamav-setup.sh" \
    "${pkgdir}/etc/zextras/pending-setups.d/carbonio-clamav-setup.sh"
  # end install carbonio-clamav consul registration artifacts
}

postinst() {
  # ClamAV consul registration
  getent group 'carbonio-clamav' >/dev/null ||
    groupadd -r 'carbonio-clamav'
  getent passwd 'carbonio-clamav' >/dev/null ||
    useradd -r -M -g 'carbonio-clamav' -s /sbin/nologin 'carbonio-clamav'

  if [ -d /run/systemd/system ]; then
    systemctl daemon-reload >/dev/null 2>&1 || :
    systemctl enable carbonio-clamav-sidecar.service >/dev/null 2>&1 || :
  fi

  echo "======================================================"
  echo "Carbonio ClamAV installed successfully!"
  echo "You must run pending-setups to configure it correctly."
  echo "======================================================"
}

prerm() {
  if [ -d /run/systemd/system ]; then
    systemctl --no-reload disable carbonio-clamav-sidecar.service >/dev/null 2>&1 || :
    systemctl stop carbonio-clamav-sidecar.service >/dev/null 2>&1 || :
  fi
}

postrm() {
  rm -f /etc/carbonio/clamav/service-discover/token

  if [ -d /run/systemd/system ]; then
    systemctl daemon-reload >/dev/null 2>&1 || :
  fi
}
