pkgname="carbonio-clamav"
pkgver="1.0.4"
pkgrel="4"
pkgdesc="Anti-virus toolkit for Unix"
arch=('x86_64')
maintainer="Zextras <packages@zextras.com>"
url="https://github.com/zextras"
depends__ubuntu_focal=(
  "carbonio-curl"
  "carbonio-libmilter"
  "carbonio-libxml2"
  "carbonio-openssl"
  "libjson-c4"
  "libpcre2-8-0"
  "zlib1g"
)
depends__ubuntu_jammy=(
  "carbonio-curl"
  "carbonio-libmilter"
  "carbonio-libxml2"
  "carbonio-openssl"
  "libjson-c5"
  "libpcre2-8-0"
  "zlib1g"
)
makedepends__apt=(
  "alien"
  "cargo"
  "check"
  "libjson-c-dev"
  "libncursesw5-dev"
  "libpcre2-dev"
  "zlib1g-dev"
)
depends__yum=(
  "carbonio-curl"
  "carbonio-libmilter"
  "carbonio-libxml2"
  "carbonio-openssl"
  "json-c"
  "pcre2"
  "zlib"
)
makedepends__yum=(
  "alien"
  "cargo"
  "check-devel"
  "json-c-devel"
  "ncurses-devel"
  "pcre2-devel"
  "zlib-devel"
)
section="utils"
priority="optional"
source=(
  "https://www.clamav.net/downloads/production/clamav-${pkgver}.tar.gz"
  "https://dl.fedoraproject.org/pub/fedora/linux/development/rawhide/Everything/x86_64/os/Packages/c/clamav-data-1.0.5-1.fc40.noarch.rpm"
  "carbonio-clamav"
  "carbonio-clamav-setup.sh"
  "carbonio-clamav-sidecar.service"
  "carbonio-clamav.hcl"
  "intentions.json"
  "policies.json"
  "service-protocol.json"
)
sha256sums=('3d6b99644874558b7de5faf9b340737a9bbc1083878fcd95a49f989c7c980146'
  '9ef86fb40199764a97a762ec63a8497c36b18bca6ee005a74eceeccdac33caf3'
  'a82946b05bdc139b790492b345eda5648c0196ce605decab33d75f661b6ed812'
  'cc36d9357d4434ff290e46a713da8246420750a5fafdf148ce0787b531a093a5'
  '9cb7401ccec50e4b28b87624c3185966366bd0f439e7ede40a1aff23812ffa45'
  'c65d4609c5be7e0cc83543bfe25e48d39451363c21e6604d5191a6953e1b3fbb'
  'df54edd32986b4213a09069681741ba7533dc40a034a6a2b080cdf380a69fb05'
  'd67bb7f9d98ccb033f632621accf3d8a3391aa3955074af958c0def644be0ef5'
  '6c1f94857671bd044fe4dac20df1f927629c50bfbb0aa9991e6de1a73d1791a0')

build() {
  export LDFLAGS="-Wl,-rpath,/opt/zextras/common/lib -L/opt/zextras/common/lib"
  export CPPFLAGS="-I/opt/zextras/common/include"
  cd "${srcdir}/clamav-${pkgver}"
  cmake . \
    -DCMAKE_INSTALL_PREFIX=/opt/zextras/common \
    -DCLAMAV_USER=zextras \
    -DCLAMAV_GROUP=zextras \
    -DENABLE_MILTER=true

  make -j16
}

package() {
  cd "${srcdir}"
  alien -t clamav-data-*.noarch.rpm

  cd "${srcdir}/clamav-${pkgver}"
  make DESTDIR="${pkgdir}" install

  mkdir -p "${pkgdir}/opt/zextras/data/clamav/db"
  tar -xvf "${srcdir}"/clamav-data-*.tgz \
    --strip-components=4 \
    -C "${pkgdir}/opt/zextras/data/clamav/db"

  find "${pkgdir}" -name '*.a' -delete
  find "${pkgdir}" -name '*.la' -delete

  rm -rf "${pkgdir}"/usr
  rm -rf "${pkgdir}"/opt/zextras/common/bin/clamav-config
  if [ -d "${pkgdir}/opt/zextras/common/lib64" ]; then
    mv "${pkgdir}/opt/zextras/common/lib64" \
      "${pkgdir}/opt/zextras/common/lib"
  fi

  # start install carbonio-clamav consul registration artifacts
  install -D -m 755 "${srcdir}/carbonio-clamav" \
    "${pkgdir}/usr/bin/carbonio-clamav"

  install -D -m 644 "${srcdir}/carbonio-clamav-sidecar.service" \
    "${pkgdir}/lib/systemd/system/carbonio-clamav-sidecar.service"

  install -D -m 644 "${srcdir}/policies.json" \
    "${pkgdir}/etc/carbonio/clamav/service-discover/policies.json"

  install -D -m 644 "${srcdir}/carbonio-clamav.hcl" \
    "${pkgdir}/etc/zextras/service-discover/carbonio-clamav.hcl"

  install -D -m 644 "${srcdir}/intentions.json" \
    "${pkgdir}/etc/carbonio/clamav/service-discover/intentions.json"

  install -D -m 644 "${srcdir}/service-protocol.json" \
    "${pkgdir}/etc/carbonio/clamav/service-discover/service-protocol.json"

  install -D -m 755 "${srcdir}/carbonio-clamav-setup.sh" \
    "${pkgdir}/etc/zextras/pending-setups.d/carbonio-clamav-setup.sh"
  # end install carbonio-clamav consul registration artifacts
}

postinst() {
  # ClamAV consul registration
  getent group 'carbonio-clamav' >/dev/null ||
    groupadd -r 'carbonio-clamav'
  getent passwd 'carbonio-clamav' >/dev/null ||
    useradd -r -M -g 'carbonio-clamav' -s /sbin/nologin 'carbonio-clamav'

  if [ -d /run/systemd/system ]; then
    systemctl daemon-reload >/dev/null 2>&1 || :
    systemctl enable carbonio-clamav-sidecar.service >/dev/null 2>&1 || :
  fi

  echo "======================================================"
  echo "Carbonio ClamAV installed successfully!"
  echo "You must run pending-setups to configure it correctly."
  echo "======================================================"
}

prerm() {
  if [ -d /run/systemd/system ]; then
    systemctl --no-reload disable carbonio-clamav-sidecar.service >/dev/null 2>&1 || :
    systemctl stop carbonio-clamav-sidecar.service >/dev/null 2>&1 || :
  fi
}

postrm() {
  rm -f /etc/carbonio/clamav/service-discover/token

  if [ -d /run/systemd/system ]; then
    systemctl daemon-reload >/dev/null 2>&1 || :
  fi
}
