targets=(
  "centos"
  "ubuntu"
)
pkgname="carbonio-mariadb"
pkgver="10.4.31"
pkgrel="1"
pkgdesc="Fast SQL database server, derived from MySQL"
pkgdesclong=(
  "Fast SQL database server, derived from MySQL"
)
arch="amd64"
maintainer="Zextras <packages@zextras.com"
url="https://zextras.com"
depends:apt=(
  "libaio1"
  "libbz2-1.0"
  "libcrack2"
  "libgnutlsxx28"
  "libpam0g"
  "libpcre3"
  "libsnappy1v5"
  "carbonio-jemalloc"
  "carbonio-curl"
  "carbonio-libxml2"
  "carbonio-openssl"
)
makedepends:apt=(
  "bison"
  "cmake"
  "cracklib-runtime"
  "flex"
  "libaio-dev"
  "libboost-atomic-dev"
  "libboost-chrono-dev"
  "libboost-date-time-dev"
  "libboost-dev"
  "libboost-filesystem-dev"
  "libboost-regex-dev"
  "libboost-system-dev"
  "libboost-thread-dev"
  "libbz2-dev"
  "libcrack2-dev"
  "libedit-dev"
  "libjudy-dev"
  "liblz4-dev"
  "libncurses5-dev"
  "libnuma-dev"
  "libpam0g-dev"
  "libpcre3-dev"
  "libsnappy-dev"
  "libzstd-dev"
  "zlib1g-dev"
)
depends:yum=(
  "cracklib"
  "bzip2"
  "libaio"
  "libzstd"
  "pam"
  "pcre"
  "snappy"
  "carbonio-jemalloc"
  "carbonio-openssl"
)
makedepends:yum=(
  "bison"
  "bzip2-devel"
  "cmake"
  "cracklib-devel"
  "flex"
  "libaio-devel"
  "libzstd-devel"
  "ncurses-devel"
  "pam-devel"
  "pcre-devel"
  "snappy-devel"
)
section="utils"
priority="optional"
sources=(
  "https://mirror.digitalnova.at/mariadb//mariadb-${pkgver}/source/mariadb-${pkgver}.tar.gz"
)
hashsums=(
  "52abf5434c6a42e0a048a63ab99a3898fb7fca1580fadd7a61bd0e9ce9b85054"
)

build() {

  export LDFLAGS="-Wl,-rpath,/opt/zextras/common/lib -L/opt/zextras/common/lib -L/usr/lib/x86_64-linux-gnu -L/usr/lib"
  export CFLAGS="-fno-omit-frame-pointer -pipe -Wall -Wno-uninitialized -DNDEBUG -I/opt/zextras/common/include -I/usr/include" 
  export CXXFLAGS="-fno-omit-frame-pointer -pipe -Wall -Wno-uninitialized -DNDEBUG -I/opt/zextras/common/include -I/usr/include" 
  export PKG_CONFIG_PATH="/opt/zextras/common/lib/pkgconfig"

  cd "${srcdir}/mariadb-${pkgver}"
  cmake . \
    -DBUILD_CONFIG=mysql_release \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=FALSE  \
    -DCMAKE_INSTALL_PREFIX="/opt/zextras/common" \
    -DCMAKE_INSTALL_RPATH="/opt/zextras/common/lib" \
    -DCMAKE_PREFIX_PATH="/opt/zextras/common" \
    -DCMAKE_SKIP_BUILD_RPATH=FALSE \
    -DCOMPILATION_COMMENT="Zextras MariaDB binary distribution" \
    -DCURL_INCLUDE_DIR=/opt/zextras/common/include \
    -DCURL_LIBRARY=/opt/zextras/common/lib \
    -DINSTALL_DOCDIR=share/mysql/docs \
    -DINSTALL_DOCREADMEDIR=share/mysql/docs \
    -DINSTALL_INFODIR=share/mysql/docs \
    -DINSTALL_MANDIR=share/man \
    -DINSTALL_MYSQLSHAREDIR=share/mysql \
    -DINSTALL_SBINDIR=sbin \
    -DINSTALL_SCRIPTDIR=share/mysql/scripts \
    -DINSTALL_SHAREDIR=share/mysql \
    -DINSTALL_SYSCONFDIR=/opt/zextras/conf \
    -DINSTALL_UNIX_ADDRDIR=/opt/zextras/data/tmp/mysql/mysql.sock \
    -DLIBXML2_INCLUDE_DIR=/opt/zextras/common/include/libxml2 \
    -DLIBXML2_LIBRARY=/opt/zextras/common/lib \
    -DPLUGIN_ARCHIVE=NO \
    -DPLUGIN_ARIA=NO \
    -DPLUGIN_BLACKHOLE=NO \
    -DPLUGIN_CONNECT=NO \
    -DPLUGIN_EXAMPLE=NO \
    -DPLUGIN_FEDERATED=NO \
    -DPLUGIN_FEDERATEDX=NO \
    -DPLUGIN_MROONGA=NO \
    -DPLUGIN_SPHINX=NO \
    -DPLUGIN_SPIDER=NO \
    -DPLUGIN_TOKUDB=NO \
    -DPYTHON_SHEBANG=/usr/bin/python3 \
    -DWITH_EMBEDDED_SERVER=OFF \
    -DWITH_FAST_MUTEXES=ON \
    -DWITH_JEMALLOC=ON \
    -DWITH_PCRE=system \
    -DWITH_SSL=yes \
    -DWITH_UNIT_TESTS=OFF \
    -DWITH_ZLIB=system \
    -Wno-dev
  make depend -j16
  make -j16
}

package() {
  cd "${srcdir}/mariadb-${pkgver}"
  make DESTDIR="${pkgdir}" install
  rm -rf "${pkgdir}"/opt/zextras/conf
  rm -rf "${pkgdir}"/opt/zextras/common/data
  rm -rf "${pkgdir}"/opt/zextras/common/mysql-test
  rm -rf "${pkgdir}"/opt/zextras/common/sql-bench
  rm -rf "${pkgdir}"/opt/zextras/common/support-files
  rm -f "${pkgdir}"/opt/zextras/common/sbin/rcmysql
  rm -f "${pkgdir}"/opt/zextras/common/lib/libmysqlclient_r.so.18
  rm -f "${pkgdir}"/opt/zextras/common/lib/libmysqlclient_r.so.18.0.0
  cd "${pkgdir}"/opt/zextras/common/lib && \
  ln -s libmysqlclient.so.18.0.0 libmysqlclient_r.so.18.0.0 && \
  ln -s libmysqlclient.so.18 libmysqlclient_r.so.18
  rm -rf "${pkgdir}"/opt/zextras/common/lib/*.a
}
