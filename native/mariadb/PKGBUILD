pkgname="carbonio-mariadb"
pkgver="10.11.14"
pkgrel="2"
pkgdesc="Fast SQL database server, derived from MySQL"
arch=('x86_64')
maintainer="Zextras <packages@zextras.com>"
url="https://github.com/zextras"
depends__apt=(
  "carbonio-curl"
  "carbonio-jemalloc"
  "carbonio-libxml2"
  "carbonio-openssl"
  "libaio1"
  "libbz2-1.0"
  "libcrack2"
  "libpam0g"
  "libpcre3"
  "libsnappy1v5"
)
depends__ubuntu_noble=(
  "carbonio-curl"
  "carbonio-jemalloc"
  "carbonio-libxml2"
  "carbonio-openssl"
  "libaio1t64"
  "libbz2-1.0"
  "libcrack2"
  "libpam0g"
  "libpcre3"
  "libsnappy1v5"
)
makedepends__apt=(
  "bison"
  "cmake"
  "cracklib-runtime"
  "flex"
  "libaio-dev"
  "libboost-atomic-dev"
  "libboost-chrono-dev"
  "libboost-date-time-dev"
  "libboost-dev"
  "libboost-filesystem-dev"
  "libboost-regex-dev"
  "libboost-system-dev"
  "libboost-thread-dev"
  "libbz2-dev"
  "libcrack2-dev"
  "libedit-dev"
  "libjudy-dev"
  "liblz4-dev"
  "libncurses5-dev"
  "libnuma-dev"
  "libpam0g-dev"
  "libpcre3-dev"
  "libsnappy-dev"
  "libzstd-dev"
  "zlib1g-dev"
)
depends__yum=(
  "bzip2"
  "carbonio-jemalloc"
  "carbonio-openssl"
  "cracklib"
  "libaio"
  "libzstd"
  "pam"
  "pcre"
  "snappy"
)
makedepends__yum=(
  "bison"
  "bzip2-devel"
  "cmake"
  "cracklib-devel"
  "flex"
  "libaio-devel"
  "libzstd-devel"
  "ncurses-devel"
  "pam-devel"
  "pcre-devel"
  "snappy-devel"
)
section="utils"
priority="optional"
source=(
  "https://mirrors.ircam.fr/pub/mariadb/mariadb-${pkgver}/source/mariadb-${pkgver}.tar.gz"
)
sha256sums=('8a571cb14fb1d4e3663d8e98f3d4200c042fc8b2a4aaaab495860dea8b7d052f')

build() {

  export LDFLAGS="-Wl,-rpath,/opt/zextras/common/lib -L/opt/zextras/common/lib -L/usr/lib/x86_64-linux-gnu -L/usr/lib"
  export CFLAGS="-fno-omit-frame-pointer -pipe -Wall -Wno-uninitialized -DNDEBUG -I/opt/zextras/common/include -I/usr/include"
  export CXXFLAGS="-fno-omit-frame-pointer -pipe -Wall -Wno-uninitialized -DNDEBUG -I/opt/zextras/common/include -I/usr/include"
  export PKG_CONFIG_PATH="/opt/zextras/common/lib/pkgconfig"

  cd "${srcdir}/mariadb-${pkgver}"

  # There's no switch to disable hashicorp_key_management
  rm -rf plugin/hashicorp_key_management

  cmake . \
    -DBUILD_CONFIG=mysql_release \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=FALSE \
    -DCMAKE_INSTALL_PREFIX="/opt/zextras/common" \
    -DCMAKE_INSTALL_RPATH="/opt/zextras/common/lib" \
    -DCMAKE_PREFIX_PATH="/opt/zextras/common" \
    -DCMAKE_SKIP_BUILD_RPATH=FALSE \
    -DCOMPILATION_COMMENT="Zextras MariaDB binary distribution" \
    -DCURL_INCLUDE_DIR=/opt/zextras/common/include \
    -DCURL_LIBRARY=/opt/zextras/common/lib \
    -DINSTALL_DOCDIR=share/mysql/docs \
    -DINSTALL_DOCREADMEDIR=share/mysql/docs \
    -DINSTALL_INFODIR=share/mysql/docs \
    -DINSTALL_MANDIR=share/man \
    -DINSTALL_MYSQLSHAREDIR=share/mysql \
    -DINSTALL_SBINDIR=sbin \
    -DINSTALL_SCRIPTDIR=share/mysql/scripts \
    -DINSTALL_SHAREDIR=share/mysql \
    -DINSTALL_SYSCONFDIR=/opt/zextras/conf \
    -DINSTALL_UNIX_ADDRDIR=/run/carbonio/mysql.sock \
    -DLIBXML2_INCLUDE_DIR=/opt/zextras/common/include/libxml2 \
    -DLIBXML2_LIBRARY=/opt/zextras/common/lib \
    -DPLUGIN_ARCHIVE=NO \
    -DPLUGIN_AUTH_PAM=NO \
    -DPLUGIN_AUTH_PAM_V1=YES \
    -DPLUGIN_AWS_KEY_MANAGEMENT=NO \
    -DPLUGIN_BINLOG=NO \
    -DPLUGIN_BLACKHOLE=NO \
    -DPLUGIN_COLUMNSTORE=NO \
    -DPLUGIN_CONNECT=NO \
    -DPLUGIN_EXAMPLE=NO \
    -DPLUGIN_FEDERATED=NO \
    -DPLUGIN_FEDERATEDX=NO \
    -DPLUGIN_MROONGA=NO \
    -DPLUGIN_S3=NO \
    -DPLUGIN_SPHINX=NO \
    -DPLUGIN_SPIDER=NO \
    -DPLUGIN_TOKUDB=NO \
    -DPYTHON_SHEBANG=/usr/bin/python3 \
    -DWITH_EMBEDDED_SERVER=OFF \
    -DWITH_FAST_MUTEXES=ON \
    -DWITH_JEMALLOC=ON \
    -DWITH_PCRE=system \
    -DWITH_SSL=yes \
    -DWITH_UNIT_TESTS=OFF \
    -DWITH_ZLIB=system \
    -Wno-dev
  make depend -j16
  make -j16
}

package() {
  cd "${srcdir}/mariadb-${pkgver}"
  make DESTDIR="${pkgdir}" install
  rm -rf "${pkgdir}/opt/zextras/conf"
  rm -rf "${pkgdir}/opt/zextras/common/data"
  rm -rf "${pkgdir}/opt/zextras/common/mysql-test"
  rm -rf "${pkgdir}/opt/zextras/common/sql-bench"
  rm -rf "${pkgdir}/opt/zextras/common/support-files"
  rm -f "${pkgdir}/opt/zextras/common/sbin/rcmysql"

  # This should be dropped in the near future
  ln -s /opt/zextras/common/lib/libmariadb.so.3 \
    "${pkgdir}/opt/zextras/common/lib/libmysqlclient.so.18.0.0"
  ln -s /opt/zextras/common/lib/libmariadb.so.3 \
    "${pkgdir}/opt/zextras/common/lib/libmysqlclient.so.18"
  ln -s /opt/zextras/common/lib/libmariadb.so.3 \
    "${pkgdir}/opt/zextras/common/lib/libmysqlclient_r.so.18.0.0"
  ln -s /opt/zextras/common/lib/libmariadb.so.3 \
    "${pkgdir}/opt/zextras/common/lib/libmysqlclient_r.so.18"

  rm -rf "${pkgdir}"/opt/zextras/common/lib/*.a
}

postinst__ubuntu_jammy() {
  if [ "$1" = "configure" ]; then
    # zmmycnf is only called at bootstrap.
    # Here we take care of upgrading scenario.
    if [ -f /opt/zextras/conf/my.cnf ]; then
      if grep -q "tmp/mysql/mysql.sock" /opt/zextras/conf/my.cnf; then
        sed -i 's!\/opt\/zextras\/data\/tmp\/mysql!\/run\/carbonio!' \
          /opt/zextras/conf/my.cnf
      fi

      if grep -q "log/mysql.pid" /opt/zextras/conf/my.cnf; then
        sed -i 's!\/opt\/zextras\/log\/mysql.pid!\/run\/carbonio/mysql.pid!' \
          /opt/zextras/conf/my.cnf
      fi
    fi

    # Handle MariaDB upgrade scenarios
    if [ -f /opt/zextras/db/data/mysql_upgrade_info ]; then
      # Check if this is a major version upgrade
      current_version="10.11.14"
      installed_version=$(cat /opt/zextras/db/data/mysql_upgrade_info | head -n1 | cut -d'-' -f1)

      # Compare major and minor version numbers
      current_major=$(echo "$current_version" | cut -d'.' -f1)
      current_minor=$(echo "$current_version" | cut -d'.' -f2)
      installed_major=$(echo "$installed_version" | cut -d'.' -f1)
      installed_minor=$(echo "$installed_version" | cut -d'.' -f2)

      if [ "$current_major" -gt "$installed_major" ] || [ "$current_major" -eq "$installed_major" -a "$current_minor" -gt "$installed_minor" ]; then
        # Perform upgrade tasks for major version upgrade
        echo "Upgrading MariaDB from version $installed_version to $current_version"

        # Restart MariaDB to load new version
        su - zextras -c 'zmmailboxdctl stop'
        su - zextras -c 'mysql.server restart'

        # Retrieve settings values from LocalConfigCLI.
        # shutil is avoided cause of default use of "#!/bin/sh"
        # in postinstall and shebang compatibility with shutil
        eval "$(/opt/zextras/common/bin/java \
          -client \
          -cp '/opt/zextras/mailbox/jars/*' \
          -Djava.library.path=/opt/zextras/lib \
          -Dzimbra.home=/opt/zextras \
          com.zimbra.cs.localconfig.LocalConfigCLI -q -m shell || true)"

        # Execute the upgrade
        echo "Running mariadb-upgrade to upgrade system tables"
        echo "WARNING: This operation can take a considerable amount of time depending on the size of your database."

        /opt/zextras/common/bin/mariadb-upgrade \
          --user="root" \
          --host="${mysql_bind_address}" \
          --port="${mysql_port}" \
          --password="${mysql_root_password}" \
          --socket="/run/carbonio/mysql.sock"

        # Restart both appserver and its db
        su - zextras -c 'mysql.server restart'
        su - zextras -c 'zmmailboxdctl start'
      fi
    fi
  fi
}

postinst__ubuntu_noble() {
  if [ "$1" = "configure" ]; then
    # zmmycnf is only called at bootstrap.
    # Here we take care of upgrading scenario.
    if [ -f /opt/zextras/conf/my.cnf ]; then
      if grep -q "tmp/mysql/mysql.sock" /opt/zextras/conf/my.cnf; then
        sed -i 's!\/opt\/zextras\/data\/tmp\/mysql!\/run\/carbonio!' \
          /opt/zextras/conf/my.cnf
      fi

      if grep -q "log/mysql.pid" /opt/zextras/conf/my.cnf; then
        sed -i 's!\/opt\/zextras\/log\/mysql.pid!\/run\/carbonio/mysql.pid!' \
          /opt/zextras/conf/my.cnf
      fi
    fi

    # Handle MariaDB upgrade scenarios
    if [ -f /opt/zextras/db/data/mysql_upgrade_info ]; then
      # Check if this is a major version upgrade
      current_version="10.11.14"
      installed_version=$(cat /opt/zextras/db/data/mysql_upgrade_info | head -n1 | cut -d'-' -f1)

      # Compare major and minor version numbers
      current_major=$(echo "$current_version" | cut -d'.' -f1)
      current_minor=$(echo "$current_version" | cut -d'.' -f2)
      installed_major=$(echo "$installed_version" | cut -d'.' -f1)
      installed_minor=$(echo "$installed_version" | cut -d'.' -f2)

      if [ "$current_major" -gt "$installed_major" ] || [ "$current_major" -eq "$installed_major" -a "$current_minor" -gt "$installed_minor" ]; then
        # Perform upgrade tasks for major version upgrade
        echo "Upgrading MariaDB from version $installed_version to $current_version"

        # Restart MariaDB to load new version
        systemctl stop carbonio-appserver-db.service &>/dev/null || :
        systemctl restart carbonio-appserver-db.service &>/dev/null || :

        # Retrieve settings values from LocalConfigCLI.
        # shutil is avoided cause of default use of "#!/bin/sh"
        # in postinstall and shebang compatibility with shutil
        eval "$(/opt/zextras/common/bin/java \
          -client \
          -cp '/opt/zextras/mailbox/jars/*' \
          -Djava.library.path=/opt/zextras/lib \
          -Dzimbra.home=/opt/zextras \
          com.zimbra.cs.localconfig.LocalConfigCLI -q -m shell || true)"

        # Execute the upgrade
        echo "Running mariadb-upgrade to upgrade system tables"
        echo "WARNING: This operation can take a considerable amount of time depending on the size of your database."

        /opt/zextras/common/bin/mariadb-upgrade \
          --user="root" \
          --host="${mysql_bind_address}" \
          --port="${mysql_port}" \
          --password="${mysql_root_password}" \
          --socket="/run/carbonio/mysql.sock"

        # Restart both appserver and its db
        systemctl restart carbonio-appserver-db.service &>/dev/null || :
        systemctl start carbonio-appserver.service &>/dev/null || :
      fi
    fi
  fi
}

postinst__rocky_8() {
  # zmmycnf is only called at bootstrap.
  # Here we take care of upgrading scenario.
  if [ -f /opt/zextras/conf/my.cnf ]; then
    if grep -q "tmp/mysql/mysql.sock" /opt/zextras/conf/my.cnf; then
      sed -i 's!\/opt\/zextras\/data\/tmp\/mysql!\/run\/carbonio!' \
        /opt/zextras/conf/my.cnf
    fi

    if grep -q "log/mysql.pid" /opt/zextras/conf/my.cnf; then
      sed -i 's!\/opt\/zextras\/log\/mysql.pid!\/run\/carbonio/mysql.pid!' \
        /opt/zextras/conf/my.cnf
    fi
  fi

  # Handle MariaDB upgrade scenarios
  if [ -f /opt/zextras/db/data/mysql_upgrade_info ]; then
    # Check if this is a major version upgrade
    current_version="10.11.14"
    installed_version=$(cat /opt/zextras/db/data/mysql_upgrade_info | head -n1 | cut -d'-' -f1)

    # Compare major and minor version numbers
    current_major=$(echo "$current_version" | cut -d'.' -f1)
    current_minor=$(echo "$current_version" | cut -d'.' -f2)
    installed_major=$(echo "$installed_version" | cut -d'.' -f1)
    installed_minor=$(echo "$installed_version" | cut -d'.' -f2)

    if [ "$current_major" -gt "$installed_major" ] || [ "$current_major" -eq "$installed_major" -a "$current_minor" -gt "$installed_minor" ]; then
      # Perform upgrade tasks for major version upgrade
      echo "Upgrading MariaDB from version $installed_version to $current_version"
      echo "WARNING: This operation can take a considerable amount of time depending on the size of your database."

      # Restart MariaDB to load new version
      su - zextras -c 'zmmailboxdctl stop'
      su - zextras -c 'mysql.server restart'

      # Retrieve settings values from LocalConfigCLI.
      # shutil is avoided cause of default use of "#!/bin/sh"
      # in postinstall and shebang compatibility with shutil
      eval "$(/opt/zextras/common/bin/java \
        -client \
        -cp '/opt/zextras/mailbox/jars/*' \
        -Djava.library.path=/opt/zextras/lib \
        -Dzimbra.home=/opt/zextras \
        com.zimbra.cs.localconfig.LocalConfigCLI -q -m shell || true)"

      # Execute the upgrade
      echo "Running mariadb-upgrade to upgrade system tables"
      echo "WARNING: This operation can take a considerable amount of time depending on the size of your database."

      /opt/zextras/common/bin/mariadb-upgrade \
        --user="root" \
        --host="${mysql_bind_address}" \
        --port="${mysql_port}" \
        --password="${mysql_root_password}" \
        --socket="/run/carbonio/mysql.sock"

      # Restart both appserver and its db
      su - zextras -c 'mysql.server restart'
      su - zextras -c 'zmmailboxdctl start'
    fi
  fi
}

postinst__rocky_9() {
  # zmmycnf is only called at bootstrap.
  # Here we take care of upgrading scenario.
  if [ -f /opt/zextras/conf/my.cnf ]; then
    if grep -q "tmp/mysql/mysql.sock" /opt/zextras/conf/my.cnf; then
      sed -i 's!\/opt\/zextras\/data\/tmp\/mysql!\/run\/carbonio!' \
        /opt/zextras/conf/my.cnf
    fi

    if grep -q "log/mysql.pid" /opt/zextras/conf/my.cnf; then
      sed -i 's!\/opt\/zextras\/log\/mysql.pid!\/run\/carbonio/mysql.pid!' \
        /opt/zextras/conf/my.cnf
    fi
  fi

  # Handle MariaDB upgrade scenarios
  if [ -f /opt/zextras/db/data/mysql_upgrade_info ]; then
    # Check if this is a major version upgrade
    current_version="10.11.14"
    installed_version=$(cat /opt/zextras/db/data/mysql_upgrade_info | head -n1 | cut -d'-' -f1)

    # Compare major and minor version numbers
    current_major=$(echo "$current_version" | cut -d'.' -f1)
    current_minor=$(echo "$current_version" | cut -d'.' -f2)
    installed_major=$(echo "$installed_version" | cut -d'.' -f1)
    installed_minor=$(echo "$installed_version" | cut -d'.' -f2)

    if [ "$current_major" -gt "$installed_major" ] || [ "$current_major" -eq "$installed_major" -a "$current_minor" -gt "$installed_minor" ]; then
      # Perform upgrade tasks for major version upgrade
      echo "Upgrading MariaDB from version $installed_version to $current_version"
      echo "WARNING: This operation can take a considerable amount of time depending on the size of your database."

      # Restart MariaDB to load new version
      systemctl stop carbonio-appserver.service &>/dev/null || :
      systemctl restart carbonio-appserver-db.service &>/dev/null || :

      # Retrieve settings values from LocalConfigCLI.
      # shutil is avoided cause of default use of "#!/bin/sh"
      # in postinstall and shebang compatibility with shutil
      eval "$(/opt/zextras/common/bin/java \
        -client \
        -cp '/opt/zextras/mailbox/jars/*' \
        -Djava.library.path=/opt/zextras/lib \
        -Dzimbra.home=/opt/zextras \
        com.zimbra.cs.localconfig.LocalConfigCLI -q -m shell || true)"

      # Execute the upgrade
      echo "Running mariadb-upgrade to upgrade system tables"
      echo "WARNING: This operation can take a considerable amount of time depending on the size of your database."

      /opt/zextras/common/bin/mariadb-upgrade \
        --user="root" \
        --host="${mysql_bind_address}" \
        --port="${mysql_port}" \
        --password="${mysql_root_password}" \
        --socket="/run/carbonio/mysql.sock"

      # Restart both appserver and its db
      systemctl restart carbonio-appserver-db.service &>/dev/null || :
      systemctl start carbonio-appserver.service &>/dev/null || :
    fi
  fi
}
