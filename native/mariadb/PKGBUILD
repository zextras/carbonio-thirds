pkgname="carbonio-mariadb"
pkgver="10.5.24"
pkgrel="1"
pkgdesc="Fast SQL database server, derived from MySQL"
arch=('x86_64')
maintainer="Zextras <packages@zextras.com>"
url="https://github.com/zextras"
depends__apt=(
  "libaio1"
  "libbz2-1.0"
  "libcrack2"
  "libgnutlsxx28"
  "libpam0g"
  "libpcre3"
  "libsnappy1v5"
  "carbonio-jemalloc"
  "carbonio-curl"
  "carbonio-libxml2"
  "carbonio-openssl"
)
makedepends__apt=(
  "bison"
  "cmake"
  "cracklib-runtime"
  "flex"
  "libaio-dev"
  "libboost-atomic-dev"
  "libboost-chrono-dev"
  "libboost-date-time-dev"
  "libboost-dev"
  "libboost-filesystem-dev"
  "libboost-regex-dev"
  "libboost-system-dev"
  "libboost-thread-dev"
  "libbz2-dev"
  "libcrack2-dev"
  "libedit-dev"
  "libjudy-dev"
  "liblz4-dev"
  "libncurses5-dev"
  "libnuma-dev"
  "libpam0g-dev"
  "libpcre3-dev"
  "libsnappy-dev"
  "libzstd-dev"
  "zlib1g-dev"
)
depends__yum=(
  "cracklib"
  "bzip2"
  "libaio"
  "libzstd"
  "pam"
  "pcre"
  "snappy"
  "carbonio-jemalloc"
  "carbonio-openssl"
)
makedepends__yum=(
  "bison"
  "bzip2-devel"
  "cmake"
  "cracklib-devel"
  "flex"
  "libaio-devel"
  "libzstd-devel"
  "ncurses-devel"
  "pam-devel"
  "pcre-devel"
  "snappy-devel"
)
section="utils"
priority="optional"
source=(
  "https://downloads.mariadb.org/rest-api/mariadb/${pkgver}/mariadb-${pkgver}.tar.gz"
)
sha256sums=('f677c5edf82aeb394cc41937aea33a3d3cc64ea2ed786adaf162b32f203d14a5')

build() {

  export LDFLAGS="-Wl,-rpath,/opt/zextras/common/lib -L/opt/zextras/common/lib -L/usr/lib/x86_64-linux-gnu -L/usr/lib"
  export CFLAGS="-fno-omit-frame-pointer -pipe -Wall -Wno-uninitialized -DNDEBUG -I/opt/zextras/common/include -I/usr/include"
  export CXXFLAGS="-fno-omit-frame-pointer -pipe -Wall -Wno-uninitialized -DNDEBUG -I/opt/zextras/common/include -I/usr/include"
  export PKG_CONFIG_PATH="/opt/zextras/common/lib/pkgconfig"

  cd "${srcdir}/mariadb-${pkgver}"
  cmake . \
    -DBUILD_CONFIG=mysql_release \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=FALSE \
    -DCMAKE_INSTALL_PREFIX="/opt/zextras/common" \
    -DCMAKE_INSTALL_RPATH="/opt/zextras/common/lib" \
    -DCMAKE_PREFIX_PATH="/opt/zextras/common" \
    -DCMAKE_SKIP_BUILD_RPATH=FALSE \
    -DCOMPILATION_COMMENT="Zextras MariaDB binary distribution" \
    -DCURL_INCLUDE_DIR=/opt/zextras/common/include \
    -DCURL_LIBRARY=/opt/zextras/common/lib \
    -DINSTALL_DOCDIR=share/mysql/docs \
    -DINSTALL_DOCREADMEDIR=share/mysql/docs \
    -DINSTALL_INFODIR=share/mysql/docs \
    -DINSTALL_MANDIR=share/man \
    -DINSTALL_MYSQLSHAREDIR=share/mysql \
    -DINSTALL_SBINDIR=sbin \
    -DINSTALL_SCRIPTDIR=share/mysql/scripts \
    -DINSTALL_SHAREDIR=share/mysql \
    -DINSTALL_SYSCONFDIR=/opt/zextras/conf \
    -DINSTALL_UNIX_ADDRDIR=/run/carbonio/mysql.sock \
    -DLIBXML2_INCLUDE_DIR=/opt/zextras/common/include/libxml2 \
    -DLIBXML2_LIBRARY=/opt/zextras/common/lib \
    -DPLUGIN_ARCHIVE=NO \
    -DPLUGIN_AUTH_PAM=NO \
    -DPLUGIN_AUTH_PAM_V1=YES \
    -DPLUGIN_AWS_KEY_MANAGEMENT=NO \
    -DPLUGIN_BINLOG=NO \
    -DPLUGIN_BLACKHOLE=NO \
    -DPLUGIN_COLUMNSTORE=NO \
    -DPLUGIN_CONNECT=NO \
    -DPLUGIN_EXAMPLE=NO \
    -DPLUGIN_FEDERATED=NO \
    -DPLUGIN_FEDERATEDX=NO \
    -DPLUGIN_MROONGA=NO \
    -DPLUGIN_S3=NO \
    -DPLUGIN_SPHINX=NO \
    -DPLUGIN_SPIDER=NO \
    -DPLUGIN_TOKUDB=NO \
    -DPYTHON_SHEBANG=/usr/bin/python3 \
    -DWITH_EMBEDDED_SERVER=OFF \
    -DWITH_FAST_MUTEXES=ON \
    -DWITH_JEMALLOC=ON \
    -DWITH_PCRE=system \
    -DWITH_SSL=yes \
    -DWITH_UNIT_TESTS=OFF \
    -DWITH_ZLIB=system \
    -Wno-dev
  make depend -j16
  make -j16
}

package() {
  cd "${srcdir}/mariadb-${pkgver}"
  make DESTDIR="${pkgdir}" install
  rm -rf "${pkgdir}/opt/zextras/conf"
  rm -rf "${pkgdir}/opt/zextras/common/data"
  rm -rf "${pkgdir}/opt/zextras/common/mysql-test"
  rm -rf "${pkgdir}/opt/zextras/common/sql-bench"
  rm -rf "${pkgdir}/opt/zextras/common/support-files"
  rm -f "${pkgdir}/opt/zextras/common/sbin/rcmysql"

  # This should be dropped in the near future
  ln -s /opt/zextras/common/lib/libmariadb.so.3 \
    "${pkgdir}/opt/zextras/common/lib/libmysqlclient.so.18.0.0"
  ln -s /opt/zextras/common/lib/libmariadb.so.3 \
    "${pkgdir}/opt/zextras/common/lib/libmysqlclient.so.18"
  ln -s /opt/zextras/common/lib/libmariadb.so.3 \
    "${pkgdir}/opt/zextras/common/lib/libmysqlclient_r.so.18.0.0"
  ln -s /opt/zextras/common/lib/libmariadb.so.3 \
    "${pkgdir}/opt/zextras/common/lib/libmysqlclient_r.so.18"

  rm -rf "${pkgdir}"/opt/zextras/common/lib/*.a
}

postinst__apt() {
  if [ "$1" = "configure" ]; then
    # creating zextras group if it isn't already there
    if ! getent group zextras >/dev/null; then
      groupadd --system zextras >/dev/null
    fi
    # creating zextras user if it isn't already there
    if ! getent passwd zextras >/dev/null; then
      useradd --system \
        -g zextras \
        -d /opt/zextras \
        --shell /bin/bash \
        zextras >/dev/null
      usermod -c "zextras user" zextras
    fi
  fi

  if [ ! -d /run/carbonio ]; then
    mkdir -p /run/carbonio
  fi
  chown zextras:zextras /run/carbonio

  # zmmycnf is only called at bootstrap.
  # Here we take care of upgrading scenario.
  if [ -f /opt/zextras/conf/my.cnf ]; then
    if grep -q "tmp/mysql/mysql.sock" /opt/zextras/conf/my.cnf; then
      sed -i 's!\/opt\/zextras\/data\/tmp\/mysql!\/run\/carbonio!' \
        /opt/zextras/conf/my.cnf
    fi

    if grep -q "log/mysql.pid" /opt/zextras/conf/my.cnf; then
      sed -i 's!\/opt\/zextras\/log\/mysql.pid!\/run\/carbonio/mysql.pid!' \
        /opt/zextras/conf/my.cnf
    fi
  fi
}

postinst__yum() {
  # creating zextras group if it isn't already there
  if ! getent group zextras >/dev/null; then
    groupadd --system zextras >/dev/null
  fi
  # creating zextras user if it isn't already there
  if ! getent passwd zextras >/dev/null; then
    useradd --system \
      -g zextras \
      -d /opt/zextras \
      --shell /bin/bash \
      zextras >/dev/null
    usermod -c "zextras user" zextras
  fi

  if [ ! -d /run/carbonio ]; then
    mkdir -p /run/carbonio
  fi

  chown zextras:zextras /run/carbonio

  # zmmycnf is only called at bootstrap.
  # Here we take care of upgrading scenario.
  if [ -f /opt/zextras/conf/my.cnf ]; then
    if grep -q "tmp/mysql/mysql.sock" /opt/zextras/conf/my.cnf; then
      sed -i 's!\/opt\/zextras\/data\/tmp\/mysql!\/run\/carbonio!' \
        /opt/zextras/conf/my.cnf
    fi

    if grep -q "log/mysql.pid" /opt/zextras/conf/my.cnf; then
      sed -i 's!\/opt\/zextras\/log\/mysql.pid!\/run\/carbonio/mysql.pid!' \
        /opt/zextras/conf/my.cnf
    fi
  fi
}
