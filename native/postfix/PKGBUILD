pkgname="carbonio-postfix"
pkgver="3.10.3" # renovate: datasource=repology depName=postfix
pkgrel="1"
pkgdesc="Fast, easy to administer, secure mail server"
arch=('x86_64')
maintainer="Zextras <packages@zextras.com>"
url="https://github.com/zextras"
depends__apt=(
  "carbonio-cyrus-sasl"
  "carbonio-mariadb"
  "carbonio-openldap"
  "carbonio-openssl"
  "libc6"
  "libpcre3"
)
depends__ubuntu_noble=(
  "carbonio-cyrus-sasl"
  "carbonio-mariadb"
  "carbonio-openldap"
  "carbonio-openssl"
  "libc6"
  "libnsl2"
  "libpcre3"
)
makedepends__apt=(
  "libc6-dev"
  "libpcre3-dev"
)
makedepends__ubuntu_noble=(
  "libc6-dev"
  "libnsl-dev"
  "libpcre3-dev"
)
depends__yum=(
  "carbonio-cyrus-sasl"
  "carbonio-mariadb>10.1.48"
  "carbonio-openldap"
  "carbonio-openssl"
  "libnsl2"
  "pcre"
)
makedepends__yum=(
  "libnsl2-devel"
  "pcre-devel"
)
section="utils"
priority="optional"
source=(
  "https://de.postfix.org/ftpmirror/official/postfix-${pkgver}.tar.gz"
  "${pkgname}.patch"
  "${pkgname}.service"
)
sha256sums=('e3cec05d91b6d2958ecd6ea9045faa35f79c5b0e228b975ace46ad2afe812053'
  'ba8d566f9814551e71875efff5f59259dba809d53aaecebae0a451d9177d7371'
  '16775c587d70cf4f4f2e885bd4e209c8d97ac03d75ac69a6b9d3fc4b58ee8366')

build() {
  cd "${srcdir}/postfix-${pkgver}"
  patch -Np1 -i "${srcdir}/carbonio-postfix.patch"

  make makefiles \
    command_directory=/opt/zextras/common/sbin \
    daemon_directory=/opt/zextras/common/libexec \
    config_directory=/opt/zextras/common/conf \
    queue_directory=/opt/zextras/data/postfix/spool \
    sendmail_path=/opt/zextras/common/sbin/sendmail \
    newalias_path=/opt/zextras/common/sbin/newaliases \
    mailq_path=/opt/zextras/common/sbin/mailq \
    manpage_directory=/opt/zextras/common/share/man \
    html_directory=no \
    readme_directory=no \
    default_database_type=lmdb \
    data_directory=/opt/zextras/data/postfix/data \
    CCARGS='\
  -DHAS_LDAP \
  -DHAS_MYSQL \
  -DNO_DB \
  -DUSE_CYRUS_SASL \
  -DHAS_LMDB \
  -DUSE_LDAP_SASL \
  -DUSE_SASL_AUTH \
  -DUSE_TLS \
  -DHAS_PCRE \
  -I/opt/zextras/common/include \
  -I/opt/zextras/common/include/mysql \
  -I/opt/zextras/common/include/sasl \
  -I/usr/include \
  -I/usr/include/pcre' \
    AUXLIBS='\
  -L/opt/zextras/common/lib \
	-lpcre -lldap -llber -llmdb -lmysqlclient -lsasl2 -lssl -lcrypto \
	-L/usr/lib -lz -lm -lpthread' \
    SHLIB_RPATH='\
  -Wl,-rpath,/opt/zextras/common/lib/postfix \
  -Wl,-rpath,/opt/zextras/common/lib \
  -L/opt/zextras/common/lib' \
    OPT='\
  -Wl,-rpath,/opt/zextras/common/lib \
  -L/opt/zextras/common/lib'

  make -j16
}

package() {
  cd "${srcdir}/postfix-${pkgver}"
  sh postfix-install -non-interactive-package install_root="${pkgdir}"
  install -Dm755 auxiliary/qshape/qshape.pl \
    "${pkgdir}"/opt/zextras/common/sbin/qshape.pl

  # systemd unit
  install -D -m 644 "${srcdir}/${pkgname}.service" \
    "${pkgdir}/usr/lib/systemd/system/${pkgname}.service"

  cd "${pkgdir}"/opt/zextras/common/sbin
  rm -f newaliases
  rm -f mailq
  ln -s sendmail mailq
  ln -s sendmail newaliases
}

postinst__apt() {
  if [ "$1" = "configure" ]; then
    # creating postfix and postdrop groups if aren't already there
    if ! getent group postdrop >/dev/null; then
      groupadd --system postdrop
    fi
    if ! getent group postfix >/dev/null; then
      groupadd --system postfix
    fi

    # creating postfix user if it isn't already there
    if ! getent passwd postfix >/dev/null; then
      useradd --system \
        -g postfix \
        -d /opt/zextras/postfix \
        -c "postfix user" \
        postfix
    fi
  fi

  usermod -a -G postfix,tty zextras
  chgrp -f postdrop /opt/zextras/common/sbin/postqueue
  chmod -f u=rwx,g=rsx,o=rx /opt/zextras/common/sbin/postqueue
  chgrp -f postdrop /opt/zextras/common/sbin/postdrop
  chmod -f u=rwx,g=rsx,o=rx /opt/zextras/common/sbin/postdrop
  chmod 755 /opt/zextras/data/postfix
  chown -fR postfix:postfix /opt/zextras/data/postfix/spool
  chown -f root /opt/zextras/data/postfix/spool
  chown -f postfix /opt/zextras/data/postfix/spool/pid
  chgrp -f root /opt/zextras/data/postfix/spool/pid
  chgrp -f postdrop /opt/zextras/data/postfix/spool/public
  chmod 730 /opt/zextras/data/postfix/spool/maildrop
  chgrp -f postdrop /opt/zextras/data/postfix/spool/maildrop
  chmod 730 /opt/zextras/data/postfix/spool/maildrop
  chown -f postfix /opt/zextras/data/postfix
  chown -f postfix /opt/zextras/data/postfix/* 2>/dev/null
  chgrp -f postdrop /opt/zextras/data/postfix/data
  chmod 755 /opt/zextras/data/postfix/data
  chown -f postfix:postfix /opt/zextras/data/postfix/data/* 2>/dev/null
  chmod -R go-w /opt/zextras/data/postfix/data
  chown -f root /opt/zextras/data/postfix/spool
  chgrp -f root /opt/zextras/data/postfix/spool
}

postinst__yum() {
  # creating postfix and postdrop groups if aren't already there
  if ! getent group postdrop >/dev/null; then
    groupadd --system postdrop
  fi
  if ! getent group postfix >/dev/null; then
    groupadd --system postfix
  fi

  # creating postfix user if it isn't already there
  if ! getent passwd postfix >/dev/null; then
    useradd --system \
      -g postfix \
      -d /opt/zextras/postfix \
      -c "postfix user" \
      postfix
  fi

  usermod -a -G postfix,tty zextras
  chgrp -f postdrop /opt/zextras/common/sbin/postqueue
  chmod -f u=rwx,g=rsx,o=rx /opt/zextras/common/sbin/postqueue
  chgrp -f postdrop /opt/zextras/common/sbin/postdrop
  chmod -f u=rwx,g=rsx,o=rx /opt/zextras/common/sbin/postdrop
  chmod 755 /opt/zextras/data/postfix
  chown -fR postfix:postfix /opt/zextras/data/postfix/spool
  chown -f root /opt/zextras/data/postfix/spool
  chown -f postfix /opt/zextras/data/postfix/spool/pid
  chgrp -f root /opt/zextras/data/postfix/spool/pid
  chgrp -f postdrop /opt/zextras/data/postfix/spool/public
  chmod 730 /opt/zextras/data/postfix/spool/maildrop
  chgrp -f postdrop /opt/zextras/data/postfix/spool/maildrop
  chmod 730 /opt/zextras/data/postfix/spool/maildrop
  chown -f postfix /opt/zextras/data/postfix
  chown -f postfix /opt/zextras/data/postfix/* 2>/dev/null
  chgrp -f postdrop /opt/zextras/data/postfix/data
  chmod 755 /opt/zextras/data/postfix/data
  chown -f postfix:postfix /opt/zextras/data/postfix/data/* 2>/dev/null
  chmod -R go-w /opt/zextras/data/postfix/data
  chown -f root /opt/zextras/data/postfix/spool
  chgrp -f root /opt/zextras/data/postfix/spool
}
