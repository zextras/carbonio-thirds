pkgname="carbonio-postfix"
pkgver="3.8.4"
pkgrel="1"
pkgdesc="Fast, easy to administer, secure mail server"
arch=('x86_64')
maintainer="Zextras <packages@zextras.com>"
url="https://github.com/zextras"
depends__apt=(
  "libc6"
  "libpcre3"
  "carbonio-openldap"
  "carbonio-cyrus-sasl"
  "carbonio-openssl"
  "carbonio-mariadb"
)
makedepends__apt=(
  "libc6-dev"
  "libpcre3-dev"
)
depends__yum=(
  "libnsl2"
  "pcre"
  "carbonio-openldap"
  "carbonio-cyrus-sasl"
  "carbonio-openssl"
  "carbonio-mariadb"
)
makedepends__yum=(
  "libnsl2-devel"
  "pcre-devel"
)
section="utils"
priority="optional"
source=(
  "https://de.postfix.org/ftpmirror/official/postfix-${pkgver}.tar.gz"
  "carbonio-postfix.patch"
)
sha256sums=('6f5848c5d8b6a7d2c5af0a9f75b0bd3f103451e912591464ab867fde085e6236'
  '15ab8397b84d66dcc4eb9a57524d80abbc72627293491f78dba6b1d6e322935c')

build() {
  cd "${srcdir}/postfix-${pkgver}"
  patch -Np1 -i "${srcdir}/carbonio-postfix.patch"

  make makefiles \
    command_directory=/opt/zextras/common/sbin \
    daemon_directory=/opt/zextras/common/libexec \
    config_directory=/opt/zextras/common/conf \
    queue_directory=/opt/zextras/data/postfix/spool \
    sendmail_path=/opt/zextras/common/sbin/sendmail \
    newalias_path=/opt/zextras/common/sbin/newaliases \
    mailq_path=/opt/zextras/common/sbin/mailq \
    manpage_directory=/opt/zextras/common/share/man \
    html_directory=no \
    readme_directory=no \
    default_database_type=lmdb \
    data_directory=/opt/zextras/data/postfix/data \
    CCARGS='\
  -DHAS_LDAP \
  -DHAS_MYSQL \
  -DNO_DB \
  -DUSE_CYRUS_SASL \
  -DHAS_LMDB \
  -DUSE_LDAP_SASL \
  -DUSE_SASL_AUTH \
  -DUSE_TLS \
  -DHAS_PCRE \
  -I/opt/zextras/common/include \
  -I/opt/zextras/common/include/mysql \
  -I/opt/zextras/common/include/sasl \
  -I/usr/include \
  -I/usr/include/pcre' \
    AUXLIBS='\
  -L/opt/zextras/common/lib \
	-lpcre -lldap -llber -llmdb -lmysqlclient -lsasl2 -lssl -lcrypto \
	-L/usr/lib -lz -lm -lpthread' \
    SHLIB_RPATH='\
  -Wl,-rpath,/opt/zextras/common/lib/postfix \
  -Wl,-rpath,/opt/zextras/common/lib \
  -L/opt/zextras/common/lib' \
    OPT='\
  -Wl,-rpath,/opt/zextras/common/lib \
  -L/opt/zextras/common/lib'

  make -j16
}

package() {
  cd "${srcdir}/postfix-${pkgver}"
  sh postfix-install -non-interactive-package install_root="${pkgdir}"
  sed -e 's|postconf|/opt/zextras/common/sbin/postconf|' auxiliary/qshape/qshape.pl >"${pkgdir}"/opt/zextras/common/sbin/qshape.pl
  chmod a+rx "${pkgdir}"/opt/zextras/common/sbin/qshape.pl
  cd "${pkgdir}"/opt/zextras/common/sbin
  rm -f newaliases
  rm -f mailq
  ln -s sendmail mailq
  ln -s sendmail newaliases
}
