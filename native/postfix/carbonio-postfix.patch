diff '--color=auto' -Naur a/auxiliary/qshape/qshape.pl b/auxiliary/qshape/qshape.pl
--- a/auxiliary/qshape/qshape.pl	2025-11-11 10:55:08.719420552 +0100
+++ b/auxiliary/qshape/qshape.pl	2025-11-11 10:55:17.298793308 +0100
@@ -169,7 +169,7 @@
 
 	$ENV{q{MAIL_CONFIG}} = $opts{"c"} if (exists $opts{"c"});
 
-	chomp(my $qdir = qx{postconf -h queue_directory});
+	chomp(my $qdir = qx{/opt/zextras/common/sbin/postconf -h queue_directory});
 	die "$0: postconf failed\n" if ($? != 0);
 	warn "'queue_directory' variable expansion not supported: $qdir\n"
 	    if ($qdir =~ /\$/);
diff '--color=auto' -Naur a/conf/main.cf b/conf/main.cf
--- a/conf/main.cf	2025-11-11 10:55:08.720043393 +0100
+++ b/conf/main.cf	2025-11-11 11:02:40.256457874 +0100
@@ -89,7 +89,7 @@
 #default_privs = nobody
 
 # INTERNET HOST AND DOMAIN NAMES
-# 
+#
 # The myhostname parameter specifies the internet hostname of this
 # mail system. The default is to use the fully-qualified domain name
 # from gethostname(). $myhostname is used as a default value for many
@@ -106,7 +106,7 @@
 #mydomain = domain.tld
 
 # SENDING MAIL
-# 
+#
 # The myorigin parameter specifies the domain that locally-posted
 # mail appears to come from. The default is to append $myhostname,
 # which is fine for small sites.  If you run a domain with multiple
@@ -203,7 +203,7 @@
 #
 # - You define $mydestination domain recipients in files other than
 #   /etc/passwd, /etc/aliases, or the $virtual_alias_maps files.
-#   For example, you define $mydestination domain recipients in    
+#   For example, you define $mydestination domain recipients in
 #   the $virtual_mailbox_maps files.
 #
 # - You redefine the local delivery agent in master.cf.
@@ -223,7 +223,7 @@
 # The right-hand side of the lookup tables is conveniently ignored.
 # In the left-hand side, specify a bare username, an @domain.tld
 # wild-card, or specify a user@domain.tld address.
-# 
+#
 #local_recipient_maps = unix:passwd.byname $alias_maps
 #local_recipient_maps = proxy:unix:passwd.byname $alias_maps
 #local_recipient_maps =
@@ -253,7 +253,7 @@
 #
 # By default (mynetworks_style = host), Postfix "trusts" only
 # the local machine.
-# 
+#
 # Specify "mynetworks_style = subnet" when Postfix should "trust"
 # SMTP clients in the same IP subnetworks as the local machine.
 # On Linux, this works correctly only with interfaces specified
@@ -264,12 +264,12 @@
 # Don't do this with a dialup site - it would cause Postfix to "trust"
 # your entire provider's network.  Instead, specify an explicit
 # mynetworks list by hand, as described below.
-#  
+#
 # Specify "mynetworks_style = host" when Postfix should "trust"
 # only the local machine.
-# 
+#
 #mynetworks_style = class
-#mynetworks_style = subnet
+mynetworks_style = subnet
 #mynetworks_style = host
 
 # Alternatively, you can specify the mynetworks list by hand, in
@@ -298,7 +298,7 @@
 # - from "untrusted" clients to destinations that match $relay_domains or
 #   subdomains thereof, except addresses with sender-specified routing.
 # The default relay_domains value is empty.
-# 
+#
 # In addition to the above, the Postfix SMTP server by default accepts mail
 # that Postfix is final destination for:
 # - destinations that match $inet_interfaces or $proxy_interfaces,
@@ -306,7 +306,7 @@
 # - destinations that match $virtual_alias_domains,
 # - destinations that match $virtual_mailbox_domains.
 # These destinations do not need to be listed in $relay_domains.
-# 
+#
 # Specify a list of hosts or domains, /file/name patterns or type:name
 # lookup tables, separated by commas and/or whitespace.  Continue
 # long lines by starting the next line with whitespace. A file name
@@ -317,7 +317,7 @@
 # list this system as their primary or backup MX host. See the
 # permit_mx_backup restriction description in postconf(5).
 #
-#relay_domains = 
+#relay_domains =
 
 # INTERNET OR INTRANET
 
@@ -351,7 +351,7 @@
 # The right-hand side of the lookup tables is conveniently ignored.
 # In the left-hand side, specify an @domain.tld wild-card, or specify
 # a user@domain.tld address.
-# 
+#
 #relay_recipient_maps = hash:/etc/postfix/relay_recipients
 
 # INPUT RATE CONTROL
@@ -360,15 +360,15 @@
 # flow control. This feature is turned on by default, although it
 # still needs further development (it's disabled on SCO UNIX due
 # to an SCO bug).
-# 
+#
 # A Postfix process will pause for $in_flow_delay seconds before
 # accepting a new message, when the message arrival rate exceeds the
 # message delivery rate. With the default 100 SMTP server process
 # limit, this limits the mail inflow to 100 messages a second more
 # than the number of messages delivered per second.
-# 
+#
 # Specify 0 to disable the feature. Valid delays are 0..10.
-# 
+#
 #in_flow_delay = 1s
 
 # ADDRESS REWRITING
@@ -398,7 +398,7 @@
 # On systems with NIS, the default is to search the local alias
 # database, then the NIS alias database. See aliases(5) for syntax
 # details.
-# 
+#
 # If you change the alias database, run "postalias /etc/aliases" (or
 # wherever your system stores the mail alias file), or simply run
 # "newaliases" to build the necessary DBM or DB file.
@@ -441,7 +441,7 @@
 #
 #home_mailbox = Mailbox
 #home_mailbox = Maildir/
- 
+
 # The mail_spool_directory parameter specifies the directory where
 # UNIX-style mailboxes are kept. The default setting depends on the
 # system type.
@@ -483,7 +483,7 @@
 #
 # NOTE: if you use this feature for accounts not in the UNIX password
 # file, then you must update the "local_recipient_maps" setting in
-# the main.cf file, otherwise the SMTP server will reject mail for    
+# the main.cf file, otherwise the SMTP server will reject mail for
 # non-UNIX accounts with "User unknown in local recipient table".
 #
 # Cyrus IMAP over LMTP. Specify ``lmtpunix      cmd="lmtpd"
@@ -505,7 +505,7 @@
 #
 # NOTE: if you use this feature for accounts not in the UNIX password
 # file, then you must update the "local_recipient_maps" setting in
-# the main.cf file, otherwise the SMTP server will reject mail for    
+# the main.cf file, otherwise the SMTP server will reject mail for
 # non-UNIX accounts with "User unknown in local recipient table".
 #
 #fallback_transport = lmtp:unix:/file/name
@@ -528,15 +528,15 @@
 #
 # NOTE: if you use this feature for accounts not in the UNIX password
 # file, then you must specify "local_recipient_maps =" (i.e. empty) in
-# the main.cf file, otherwise the SMTP server will reject mail for    
+# the main.cf file, otherwise the SMTP server will reject mail for
 # non-UNIX accounts with "User unknown in local recipient table".
 #
 #luser_relay = $user@other.host
 #luser_relay = $local@other.host
 #luser_relay = admin+$local
-  
+
 # JUNK MAIL CONTROLS
-# 
+#
 # The controls listed here are only a very small subset. The file
 # SMTPD_ACCESS_README provides an overview.
 
@@ -550,7 +550,7 @@
 #
 # For details, see "man header_checks".
 #
-#header_checks = regexp:/etc/postfix/header_checks
+header_checks = pcre:/opt/zextras/conf/postfix_header_checks
 
 # FAST ETRN SERVICE
 #
@@ -558,11 +558,11 @@
 # deferred mail, so that mail can be flushed quickly with the SMTP
 # "ETRN domain.tld" command, or by executing "sendmail -qRdomain.tld".
 # See the ETRN_README document for a detailed description.
-# 
+#
 # The fast_flush_domains parameter controls what destinations are
 # eligible for this service. By default, they are all domains that
 # this server is willing to relay mail to.
-# 
+#
 #fast_flush_domains = $relay_domains
 
 # SHOW SOFTWARE VERSION OR NOT
@@ -586,7 +586,7 @@
 # too many are run at the same time. With SMTP deliveries, 10
 # simultaneous connections to the same domain could be sufficient to
 # raise eyebrows.
-# 
+#
 # Each message delivery transport has its XXX_destination_concurrency_limit
 # parameter.  The default is $default_destination_concurrency_limit for
 # most delivery transports. For the local delivery agent the default is 2.
@@ -644,10 +644,10 @@
 # INSTALL-TIME CONFIGURATION INFORMATION
 #
 # The following parameters are used when installing a new Postfix version.
-# 
+#
 # sendmail_path: The full pathname of the Postfix sendmail command.
 # This is the Sendmail-compatible mail posting interface.
-# 
+#
 sendmail_path =
 
 # newaliases_path: The full pathname of the Postfix newaliases command.
@@ -657,7 +657,7 @@
 
 # mailq_path: The full pathname of the Postfix mailq command.  This
 # is the Sendmail-compatible mail queue listing command.
-# 
+#
 mailq_path =
 
 # setgid_group: The group for mail submission and queue management
@@ -682,6 +682,54 @@
 # readme_directory: The location of the Postfix README files.
 #
 readme_directory =
-inet_protocols = ipv4
-shlib_directory = /usr/lib/postfix/${mail_version}
-meta_directory = /etc/postfix
+inet_protocols = all
+shlib_directory = /opt/zextras/common/lib/postfix/${mail_version}
+meta_directory = /opt/zextras/common/conf
+
+# Zextras changes
+#
+# Source: https://www.postfix.org/smtp-smuggling.html
+# Optionally disconnect remote SMTP clients that send bare newlines,
+# but allow local clients with non-standard SMTP implementations
+# such as netcat, fax machines, or load balancer health checks.
+#
+smtpd_forbid_bare_newline = yes
+smtpd_forbid_bare_newline_exclusions = $mynetworks
+
+virtual_mailbox_maps = proxy:ldap:/opt/zextras/conf/ldap-vmm.cf
+virtual_mailbox_domains = proxy:ldap:/opt/zextras/conf/ldap-vmd.cf
+virtual_alias_maps = proxy:ldap:/opt/zextras/conf/ldap-vam.cf
+virtual_alias_domains = proxy:ldap:/opt/zextras/conf/ldap-vad.cf
+virtual_transport = error
+canonical_maps = proxy:ldap:/opt/zextras/conf/ldap-canonical.cf
+transport_maps = proxy:ldap:/opt/zextras/conf/ldap-transport.cf
+
+# If (email domain name == host name), we don't want $myhostname in
+# mydestination for testing purposes.
+mydestination = localhost.localdomain localhost
+
+# Disable NIS which is in the default
+alias_maps = lmdb:/etc/aliases
+
+# Security hardening
+allow_mail_to_commands =
+allow_mail_to_files =
+disable_vrfy_command = yes
+smtpd_helo_required = yes
+smtpd_client_restrictions = reject_unauth_pipelining
+smtpd_data_restrictions = reject_unauth_pipelining
+smtpd_recipient_restrictions =
+       reject_non_fqdn_recipient,
+       permit_sasl_authenticated,
+       permit_mynetworks,
+       reject_unauth_destination
+
+broken_sasl_auth_clients = yes
+
+smtpd_tls_security_level = may
+smtpd_tls_cert_file = /opt/zextras/conf/smtpd.crt
+smtpd_tls_key_file = /opt/zextras/conf/smtpd.key
+smtpd_tls_loglevel = 3
+smtputf8_enable = no
+smtpd_forbid_bare_newline = yes
+smtpd_forbid_bare_newline_exclusions = $mynetworks
diff '--color=auto' -Naur a/conf/postfix-script b/conf/postfix-script
--- a/conf/postfix-script	2025-11-11 10:55:08.720189162 +0100
+++ b/conf/postfix-script	2025-11-11 10:55:17.299952995 +0100
@@ -306,7 +306,7 @@
 
 	# Check Postfix root-owned directory owner/permissions.
 
-	find $queue_directory/. $queue_directory/pid \
+	find $queue_directory/. \
 	    -prune ! -user root \
 	    -exec $WARN not owned by root: {} \;
 
@@ -316,18 +316,23 @@
 
 	# Check Postfix root-owned directory tree owner/permissions.
 
-	todo="$config_directory/."
+	todo=""
 	test -n "$check_shared_files" && {
-		todo="$daemon_directory/. $meta_directory/. $todo"
+		todo="$daemon_directory/. $meta_directory/."
 		test "$shlib_directory" = "no" || 
 		    todo="$shlib_directory/. $todo"
 	}
+	if [ x"$todo" != "x" ]
+	then
+		todo=`echo "$todo" | tr ' ' '\12' | sort -u`
+		find $todo -path /opt/zextras/common/conf/. -prune -o ! -user root \
+	    	-exec $WARN not owned by root: {} \;
+	fi
+	todo="$todo $config_directory/."
 	todo=`echo "$todo" | tr ' ' '\12' | sort -u`
-
-	find $todo ! -user root \
-	    -exec $WARN not owned by root: {} \;
-
-	find $todo \( -perm -020 -o -perm -002 \) \
+	find $todo  -path /opt/zextras/common/libexec/./openldap -prune -o \
+            -path /opt/zextras/common/conf/. -prune -o \
+            \( -perm -020 -o -perm -002 \) \
 	    -exec $WARN group or other writable: {} \;
 
 	# Check Postfix mail_owner-owned directory tree owner/permissions.
diff '--color=auto' -Naur a/proto/ldap_table b/proto/ldap_table
--- a/proto/ldap_table	2025-11-11 10:55:08.743377299 +0100
+++ b/proto/ldap_table	2025-11-11 10:55:17.300022370 +0100
@@ -146,6 +146,14 @@
 #	When the input key is an address of the form user@domain, \fB%d\fR
 #	is replaced by the (RFC 2253) quoted domain part of the address.
 #	Otherwise, the search is suppressed and returns no results.
+# .IP "\fB\fB%,\fR\fR"
+#	When the input key is an address of the form user@domain, \fB%,\fR
+#	is replaced by the sequence of comma separated domain component RDNs
+#	of the domain part of the address.  Otherwise, the search is
+#	suppressed and returns no results.
+# .IP
+# 	For example, with a lookup key of user@mail.example.com, the
+#	replacement string is "dc=mail, dc=example, dc=com".
 # .IP "\fB%[SUD]\fR"
 #	For the \fBsearch_base\fR parameter, the upper-case equivalents
 #	of the above expansions behave identically to their lower-case
diff '--color=auto' -Naur a/src/global/db_common.c b/src/global/db_common.c
--- a/src/global/db_common.c	2025-11-11 10:55:08.762848070 +0100
+++ b/src/global/db_common.c	2025-11-11 10:55:17.300467378 +0100
@@ -149,6 +149,7 @@
   * Utility library.
   */
 #include <mymalloc.h>
+#include <stringops.h>
 #include <vstring.h>
 #include <msg.h>
 #include <dict.h>
@@ -207,6 +208,15 @@
 		    : DB_COMMON_VALUE_USER;
 		dynamic = 1;
 		break;
+	    case ',':
+		if (query & DB_COMMON_LDAP_BASE) {
+		    ctx->flags |= DB_COMMON_KEY_DOMAIN | DB_COMMON_KEY_PARTIAL;
+		    dynamic = 1;
+		    break;
+		}
+		msg_fatal("db_common_parse: %s: Invalid %s template: %s",
+		       ctx->dict->name, query ? "query" : "result", format);
+		break;
 	    case 'd':
 		ctx->flags |=
 		    query ? DB_COMMON_KEY_DOMAIN | DB_COMMON_KEY_PARTIAL
@@ -316,6 +326,8 @@
     ARGV   *parts = 0;
     int     i;
     const char *cp;
+    char   *save;
+    char   *tmp;
 
     /* Skip NULL values, silently. */
     if (value == 0)
@@ -413,6 +425,21 @@
 		VSTRING_ADDCH(result, '%');
 		break;
 
+	    case ',':
+		if (!(ctx->flags & DB_COMMON_KEY_DOMAIN))
+		    msg_panic("%s: %s: %s: bad query template context",
+			      myname, ctx->dict->name, format);
+		if (!vdomain)
+		    msg_panic("%s: %s: %s: expanding domain-less key",
+			      myname, ctx->dict->name, format);
+		save = tmp = mystrdup(vdomain);
+		for (i = 0; (domain = mystrtok(&tmp, ".")) != 0; i = 1) {
+		    vstring_strcat(result, i ? ", dc=" : "dc=");
+		    QUOTE_VAL(ctx->dict, quote_func, domain, result);
+		}
+		myfree(save);
+		break;
+
 	    case 's':
 		QUOTE_VAL(ctx->dict, quote_func, value, result);
 		break;
diff '--color=auto' -Naur a/src/global/db_common.h b/src/global/db_common.h
--- a/src/global/db_common.h	2025-11-11 10:55:08.762881984 +0100
+++ b/src/global/db_common.h	2025-11-11 10:55:17.300650492 +0100
@@ -18,6 +18,10 @@
 #include "dict.h"
 #include "string_list.h"
 
+#define DB_COMMON_RESULT	0	/* Must be false */
+#define DB_COMMON_QUERY 	1
+#define DB_COMMON_LDAP_BASE	2
+
 typedef void (*db_quote_callback_t) (DICT *, const char *, VSTRING *);
 
 extern int db_common_parse(DICT *, void **, const char *, int);
diff '--color=auto' -Naur a/src/global/dict_ldap.c b/src/global/dict_ldap.c
--- a/src/global/dict_ldap.c	2025-11-11 10:55:08.763369383 +0100
+++ b/src/global/dict_ldap.c	2025-11-11 10:55:17.300890429 +0100
@@ -1347,8 +1347,9 @@
      * On to the search.
      */
     if (msg_verbose)
-	msg_info("%s: %s: Searching with filter %s", myname,
-		 dict_ldap->parser->name, vstring_str(query));
+	msg_info("%s: %s: Searching with base %s filter %s", myname,
+		 dict_ldap->parser->name,
+		 vstring_str(base), vstring_str(query));
 
     rc = search_st(dict_ldap->ld, vstring_str(base), dict_ldap->scope,
 		   vstring_str(query), dict_ldap->result_attributes->argv,
@@ -1680,12 +1681,14 @@
     dict_ldap->ctx = 0;
     dict_ldap->dynamic_base =
 	db_common_parse(&dict_ldap->dict, &dict_ldap->ctx,
-			dict_ldap->search_base, 1);
-    if (!db_common_parse(0, &dict_ldap->ctx, dict_ldap->query, 1)) {
+			dict_ldap->search_base, DB_COMMON_LDAP_BASE);
+    if (!db_common_parse(0, &dict_ldap->ctx, dict_ldap->query,
+			 DB_COMMON_QUERY)) {
 	msg_warn("%s: %s: Fixed query_filter %s is probably useless",
 		 myname, ldapsource, dict_ldap->query);
     }
-    (void) db_common_parse(0, &dict_ldap->ctx, dict_ldap->result_format, 0);
+    (void) db_common_parse(0, &dict_ldap->ctx, dict_ldap->result_format,
+			   DB_COMMON_RESULT);
     db_common_parse_domain(dict_ldap->parser, dict_ldap->ctx);
 
     /*
diff '--color=auto' -Naur a/src/global/dict_memcache.c b/src/global/dict_memcache.c
--- a/src/global/dict_memcache.c	2025-11-11 10:55:08.763452756 +0100
+++ b/src/global/dict_memcache.c	2025-11-11 10:55:17.301183301 +0100
@@ -584,7 +584,7 @@
      */
     dict_mc->dbc_ctxt = 0;
     db_common_parse(&dict_mc->dict, &dict_mc->dbc_ctxt,
-		    dict_mc->key_format, 1);
+		    dict_mc->key_format, DB_COMMON_QUERY);
     db_common_parse_domain(dict_mc->parser, dict_mc->dbc_ctxt);
     if (db_common_dict_partial(dict_mc->dbc_ctxt))
 	/* Breaks recipient delimiters */
diff '--color=auto' -Naur a/src/global/dict_mysql.c b/src/global/dict_mysql.c
--- a/src/global/dict_mysql.c	2025-11-11 10:55:08.763593855 +0100
+++ b/src/global/dict_mysql.c	2025-11-11 10:55:17.301367407 +0100
@@ -732,8 +732,9 @@
      */
     dict_mysql->ctx = 0;
     (void) db_common_parse(&dict_mysql->dict, &dict_mysql->ctx,
-			   dict_mysql->query, 1);
-    (void) db_common_parse(0, &dict_mysql->ctx, dict_mysql->result_format, 0);
+			   dict_mysql->query, DB_COMMON_QUERY);
+    (void) db_common_parse(0, &dict_mysql->ctx, dict_mysql->result_format,
+			   DB_COMMON_RESULT);
     db_common_parse_domain(p, dict_mysql->ctx);
 
     /*
diff '--color=auto' -Naur a/src/global/dict_pgsql.c b/src/global/dict_pgsql.c
--- a/src/global/dict_pgsql.c	2025-11-11 10:55:08.763664052 +0100
+++ b/src/global/dict_pgsql.c	2025-11-11 10:55:17.301600739 +0100
@@ -664,8 +664,9 @@
      */
     dict_pgsql->ctx = 0;
     (void) db_common_parse(&dict_pgsql->dict, &dict_pgsql->ctx,
-			   dict_pgsql->query, 1);
-    (void) db_common_parse(0, &dict_pgsql->ctx, dict_pgsql->result_format, 0);
+			   dict_pgsql->query, DB_COMMON_QUERY);
+    (void) db_common_parse(0, &dict_pgsql->ctx, dict_pgsql->result_format,
+			   DB_COMMON_RESULT);
     db_common_parse_domain(p, dict_pgsql->ctx);
 
     /*
diff '--color=auto' -Naur a/src/global/dict_sqlite.c b/src/global/dict_sqlite.c
--- a/src/global/dict_sqlite.c	2025-11-11 10:55:08.763796377 +0100
+++ b/src/global/dict_sqlite.c	2025-11-11 10:55:17.301764681 +0100
@@ -278,8 +278,9 @@
      */
     dict_sqlite->ctx = 0;
     (void) db_common_parse(&dict_sqlite->dict, &dict_sqlite->ctx,
-			   dict_sqlite->query, 1);
-    (void) db_common_parse(0, &dict_sqlite->ctx, dict_sqlite->result_format, 0);
+			   dict_sqlite->query, DB_COMMON_QUERY);
+    (void) db_common_parse(0, &dict_sqlite->ctx, dict_sqlite->result_format,
+			   DB_COMMON_RESULT);
     db_common_parse_domain(dict_sqlite->parser, dict_sqlite->ctx);
 
     /*
diff '--color=auto' -Naur a/src/global/mail_params.h b/src/global/mail_params.h
--- a/src/global/mail_params.h	2025-11-11 10:55:08.768733158 +0100
+++ b/src/global/mail_params.h	2025-11-11 10:55:17.302022308 +0100
@@ -2932,7 +2932,7 @@
 extern char *var_verify_service;
 
 #define VAR_VERIFY_MAP			"address_verify_map"
-#define DEF_VERIFY_MAP			"btree:$data_directory/verify_cache"
+#define DEF_VERIFY_MAP			"lmdb:$data_directory/verify_cache"
 extern char *var_verify_map;
 
 #define VAR_VERIFY_POS_EXP		"address_verify_positive_expire_time"
@@ -3752,7 +3752,7 @@
   * postscreen(8)
   */
 #define VAR_PSC_CACHE_MAP	"postscreen_cache_map"
-#define DEF_PSC_CACHE_MAP	"btree:$data_directory/postscreen_cache"
+#define DEF_PSC_CACHE_MAP	"lmdb:$data_directory/postscreen_cache"
 extern char *var_psc_cache_map;
 
 #define VAR_SMTPD_SERVICE	"smtpd_service_name"
