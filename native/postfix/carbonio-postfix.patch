diff '--color=auto' -Naur a/auxiliary/qshape/qshape.pl b/auxiliary/qshape/qshape.pl
--- a/auxiliary/qshape/qshape.pl	2024-01-05 17:01:47.137924220 +0100
+++ b/auxiliary/qshape/qshape.pl	2024-01-05 17:01:49.876884335 +0100
@@ -169,7 +169,7 @@
 
 	$ENV{q{MAIL_CONFIG}} = $opts{"c"} if (exists $opts{"c"});
 
-	chomp(my $qdir = qx{postconf -h queue_directory});
+	chomp(my $qdir = qx{/opt/zextras/common/sbin/postconf -h queue_directory});
 	die "$0: postconf failed\n" if ($? != 0);
 	warn "'queue_directory' variable expansion not supported: $qdir\n"
 	    if ($qdir =~ /\$/);
diff '--color=auto' -Naur a/conf/main.cf b/conf/main.cf
--- a/conf/main.cf	2024-01-05 17:01:47.138924206 +0100
+++ b/conf/main.cf	2024-01-05 17:02:30.157296486 +0100
@@ -269,7 +269,7 @@
 # only the local machine.
 # 
 #mynetworks_style = class
-#mynetworks_style = subnet
+mynetworks_style = subnet
 #mynetworks_style = host
 
 # Alternatively, you can specify the mynetworks list by hand, in
@@ -550,7 +550,7 @@
 #
 # For details, see "man header_checks".
 #
-#header_checks = regexp:/etc/postfix/header_checks
+header_checks = pcre:/opt/zextras/conf/postfix_header_checks
 
 # FAST ETRN SERVICE
 #
@@ -682,4 +682,52 @@
 # readme_directory: The location of the Postfix README files.
 #
 readme_directory =
-inet_protocols = ipv4
+inet_protocols = all
+
+# Source: https://www.postfix.org/smtp-smuggling.html
+# Optionally disconnect remote SMTP clients that send bare newlines,
+# but allow local clients with non-standard SMTP implementations
+# such as netcat, fax machines, or load balancer health checks.
+#
+smtpd_forbid_bare_newline = yes
+smtpd_forbid_bare_newline_exclusions = $mynetworks
+
+# Zextras changes
+#
+virtual_mailbox_maps = proxy:ldap:/opt/zextras/conf/ldap-vmm.cf
+virtual_mailbox_domains = proxy:ldap:/opt/zextras/conf/ldap-vmd.cf
+virtual_alias_maps = proxy:ldap:/opt/zextras/conf/ldap-vam.cf
+virtual_alias_domains = proxy:ldap:/opt/zextras/conf/ldap-vad.cf
+virtual_transport = error
+canonical_maps = proxy:ldap:/opt/zextras/conf/ldap-canonical.cf
+transport_maps = proxy:ldap:/opt/zextras/conf/ldap-transport.cf
+
+# If (email domain name == host name), we don't want $myhostname in
+# mydestination for testing purposes.
+mydestination = localhost.localdomain localhost
+
+# Disable NIS which is in the default
+alias_maps = lmdb:/etc/aliases
+
+# for security...
+allow_mail_to_commands =
+allow_mail_to_files =
+
+smtpd_helo_required = yes
+smtpd_client_restrictions = reject_unauth_pipelining
+smtpd_data_restrictions = reject_unauth_pipelining
+smtpd_recipient_restrictions =
+       reject_non_fqdn_recipient,
+       permit_sasl_authenticated,
+       permit_mynetworks,
+       reject_unauth_destination
+
+broken_sasl_auth_clients = yes
+
+smtpd_use_tls = yes
+smtpd_tls_cert_file = /opt/zextras/conf/smtpd.crt
+smtpd_tls_key_file = /opt/zextras/conf/smtpd.key
+smtpd_tls_loglevel = 3
+smtputf8_enable = no
+smtpd_forbid_bare_newline = yes
+smtpd_forbid_bare_newline_exclusions = $mynetworks
diff '--color=auto' -Naur a/conf/postfix-script b/conf/postfix-script
--- a/conf/postfix-script	2024-01-05 17:01:47.138924206 +0100
+++ b/conf/postfix-script	2024-01-05 17:01:49.877884320 +0100
@@ -293,7 +293,7 @@
 
 	# Check Postfix root-owned directory owner/permissions.
 
-	find $queue_directory/. $queue_directory/pid \
+	find $queue_directory/. \
 	    -prune ! -user root \
 	    -exec $WARN not owned by root: {} \;
 
@@ -303,18 +303,23 @@
 
 	# Check Postfix root-owned directory tree owner/permissions.
 
-	todo="$config_directory/."
+	todo=""
 	test -n "$check_shared_files" && {
-		todo="$daemon_directory/. $meta_directory/. $todo"
+		todo="$daemon_directory/. $meta_directory/."
 		test "$shlib_directory" = "no" || 
 		    todo="$shlib_directory/. $todo"
 	}
+	if [ x"$todo" != "x" ]
+	then
+		todo=`echo "$todo" | tr ' ' '\12' | sort -u`
+		find $todo -path /opt/zextras/common/conf/. -prune -o ! -user root \
+	    	-exec $WARN not owned by root: {} \;
+	fi
+	todo="$todo $config_directory/."
 	todo=`echo "$todo" | tr ' ' '\12' | sort -u`
-
-	find $todo ! -user root \
-	    -exec $WARN not owned by root: {} \;
-
-	find $todo \( -perm -020 -o -perm -002 \) \
+	find $todo  -path /opt/zextras/common/libexec/./openldap -prune -o \
+            -path /opt/zextras/common/conf/. -prune -o \
+            \( -perm -020 -o -perm -002 \) \
 	    -exec $WARN group or other writable: {} \;
 
 	# Check Postfix mail_owner-owned directory tree owner/permissions.
diff '--color=auto' -Naur a/proto/ldap_table b/proto/ldap_table
--- a/proto/ldap_table	2024-01-05 17:01:47.148924060 +0100
+++ b/proto/ldap_table	2024-01-05 17:01:49.877884320 +0100
@@ -142,6 +142,14 @@
 #	When the input key is an address of the form user@domain, \fB%d\fR
 #	is replaced by the (RFC 2253) quoted domain part of the address.
 #	Otherwise, the search is suppressed and returns no results.
+# .IP "\fB\fB%,\fR\fR"
+#	When the input key is an address of the form user@domain, \fB%,\fR
+#	is replaced by the sequence of comma separated domain component RDNs
+#	of the domain part of the address.  Otherwise, the search is
+#	suppressed and returns no results.
+# .IP
+# 	For example, with a lookup key of user@mail.example.com, the
+#	replacement string is "dc=mail, dc=example, dc=com".
 # .IP "\fB%[SUD]\fR"
 #	For the \fBsearch_base\fR parameter, the upper-case equivalents
 #	of the above expansions behave identically to their lower-case
diff '--color=auto' -Naur a/src/global/db_common.c b/src/global/db_common.c
--- a/src/global/db_common.c	2024-01-05 17:01:47.156923943 +0100
+++ b/src/global/db_common.c	2024-01-05 17:01:49.877884320 +0100
@@ -149,6 +149,7 @@
   * Utility library.
   */
 #include <mymalloc.h>
+#include <stringops.h>
 #include <vstring.h>
 #include <msg.h>
 #include <dict.h>
@@ -207,6 +208,15 @@
 		    : DB_COMMON_VALUE_USER;
 		dynamic = 1;
 		break;
+	    case ',':
+		if (query & DB_COMMON_LDAP_BASE) {
+		    ctx->flags |= DB_COMMON_KEY_DOMAIN | DB_COMMON_KEY_PARTIAL;
+		    dynamic = 1;
+		    break;
+		}
+		msg_fatal("db_common_parse: %s: Invalid %s template: %s",
+		       ctx->dict->name, query ? "query" : "result", format);
+		break;
 	    case 'd':
 		ctx->flags |=
 		    query ? DB_COMMON_KEY_DOMAIN | DB_COMMON_KEY_PARTIAL
@@ -316,6 +326,8 @@
     ARGV   *parts = 0;
     int     i;
     const char *cp;
+    char   *save;
+    char   *tmp;
 
     /* Skip NULL values, silently. */
     if (value == 0)
@@ -413,6 +425,21 @@
 		VSTRING_ADDCH(result, '%');
 		break;
 
+	    case ',':
+		if (!(ctx->flags & DB_COMMON_KEY_DOMAIN))
+		    msg_panic("%s: %s: %s: bad query template context",
+			      myname, ctx->dict->name, format);
+		if (!vdomain)
+		    msg_panic("%s: %s: %s: expanding domain-less key",
+			      myname, ctx->dict->name, format);
+		save = tmp = mystrdup(vdomain);
+		for (i = 0; (domain = mystrtok(&tmp, ".")) != 0; i = 1) {
+		    vstring_strcat(result, i ? ", dc=" : "dc=");
+		    QUOTE_VAL(ctx->dict, quote_func, domain, result);
+		}
+		myfree(save);
+		break;
+
 	    case 's':
 		QUOTE_VAL(ctx->dict, quote_func, value, result);
 		break;
diff '--color=auto' -Naur a/src/global/db_common.h b/src/global/db_common.h
--- a/src/global/db_common.h	2024-01-05 17:01:47.156923943 +0100
+++ b/src/global/db_common.h	2024-01-05 17:01:49.878884306 +0100
@@ -18,6 +18,10 @@
 #include "dict.h"
 #include "string_list.h"
 
+#define DB_COMMON_RESULT	0	/* Must be false */
+#define DB_COMMON_QUERY 	1
+#define DB_COMMON_LDAP_BASE	2
+
 typedef void (*db_quote_callback_t)(DICT *, const char *, VSTRING *);
 
 extern int db_common_parse(DICT *, void **, const char *, int);
diff '--color=auto' -Naur a/src/global/dict_ldap.c b/src/global/dict_ldap.c
--- a/src/global/dict_ldap.c	2024-01-05 17:01:47.156923943 +0100
+++ b/src/global/dict_ldap.c	2024-01-05 17:01:49.878884306 +0100
@@ -1347,8 +1347,9 @@
      * On to the search.
      */
     if (msg_verbose)
-	msg_info("%s: %s: Searching with filter %s", myname,
-		 dict_ldap->parser->name, vstring_str(query));
+	msg_info("%s: %s: Searching with base %s filter %s", myname,
+		 dict_ldap->parser->name,
+		 vstring_str(base), vstring_str(query));
 
     rc = search_st(dict_ldap->ld, vstring_str(base), dict_ldap->scope,
 		   vstring_str(query), dict_ldap->result_attributes->argv,
@@ -1680,12 +1681,14 @@
     dict_ldap->ctx = 0;
     dict_ldap->dynamic_base =
 	db_common_parse(&dict_ldap->dict, &dict_ldap->ctx,
-			dict_ldap->search_base, 1);
-    if (!db_common_parse(0, &dict_ldap->ctx, dict_ldap->query, 1)) {
+			dict_ldap->search_base, DB_COMMON_LDAP_BASE);
+    if (!db_common_parse(0, &dict_ldap->ctx, dict_ldap->query,
+			 DB_COMMON_QUERY)) {
 	msg_warn("%s: %s: Fixed query_filter %s is probably useless",
 		 myname, ldapsource, dict_ldap->query);
     }
-    (void) db_common_parse(0, &dict_ldap->ctx, dict_ldap->result_format, 0);
+    (void) db_common_parse(0, &dict_ldap->ctx, dict_ldap->result_format,
+			   DB_COMMON_RESULT);
     db_common_parse_domain(dict_ldap->parser, dict_ldap->ctx);
 
     /*
diff '--color=auto' -Naur a/src/global/dict_memcache.c b/src/global/dict_memcache.c
--- a/src/global/dict_memcache.c	2024-01-05 17:01:47.156923943 +0100
+++ b/src/global/dict_memcache.c	2024-01-05 17:01:49.879884291 +0100
@@ -584,7 +584,7 @@
      */
     dict_mc->dbc_ctxt = 0;
     db_common_parse(&dict_mc->dict, &dict_mc->dbc_ctxt,
-		    dict_mc->key_format, 1);
+		    dict_mc->key_format, DB_COMMON_QUERY);
     db_common_parse_domain(dict_mc->parser, dict_mc->dbc_ctxt);
     if (db_common_dict_partial(dict_mc->dbc_ctxt))
 	/* Breaks recipient delimiters */
diff '--color=auto' -Naur a/src/global/dict_mysql.c b/src/global/dict_mysql.c
--- a/src/global/dict_mysql.c	2024-01-05 17:01:47.156923943 +0100
+++ b/src/global/dict_mysql.c	2024-01-05 17:01:49.879884291 +0100
@@ -684,8 +684,9 @@
      */
     dict_mysql->ctx = 0;
     (void) db_common_parse(&dict_mysql->dict, &dict_mysql->ctx,
-			   dict_mysql->query, 1);
-    (void) db_common_parse(0, &dict_mysql->ctx, dict_mysql->result_format, 0);
+			   dict_mysql->query, DB_COMMON_QUERY);
+    (void) db_common_parse(0, &dict_mysql->ctx, dict_mysql->result_format,
+			   DB_COMMON_RESULT);
     db_common_parse_domain(p, dict_mysql->ctx);
 
     /*
diff '--color=auto' -Naur a/src/global/dict_pgsql.c b/src/global/dict_pgsql.c
--- a/src/global/dict_pgsql.c	2024-01-05 17:01:47.156923943 +0100
+++ b/src/global/dict_pgsql.c	2024-01-05 17:01:49.879884291 +0100
@@ -665,8 +665,9 @@
      */
     dict_pgsql->ctx = 0;
     (void) db_common_parse(&dict_pgsql->dict, &dict_pgsql->ctx,
-			   dict_pgsql->query, 1);
-    (void) db_common_parse(0, &dict_pgsql->ctx, dict_pgsql->result_format, 0);
+			   dict_pgsql->query, DB_COMMON_QUERY);
+    (void) db_common_parse(0, &dict_pgsql->ctx, dict_pgsql->result_format,
+			   DB_COMMON_RESULT);
     db_common_parse_domain(p, dict_pgsql->ctx);
 
     /*
diff '--color=auto' -Naur a/src/global/dict_sqlite.c b/src/global/dict_sqlite.c
--- a/src/global/dict_sqlite.c	2024-01-05 17:01:47.156923943 +0100
+++ b/src/global/dict_sqlite.c	2024-01-05 17:01:49.880884276 +0100
@@ -275,8 +275,9 @@
      */
     dict_sqlite->ctx = 0;
     (void) db_common_parse(&dict_sqlite->dict, &dict_sqlite->ctx,
-			   dict_sqlite->query, 1);
-    (void) db_common_parse(0, &dict_sqlite->ctx, dict_sqlite->result_format, 0);
+			   dict_sqlite->query, DB_COMMON_QUERY);
+    (void) db_common_parse(0, &dict_sqlite->ctx, dict_sqlite->result_format,
+			   DB_COMMON_RESULT);
     db_common_parse_domain(dict_sqlite->parser, dict_sqlite->ctx);
 
     /*
diff '--color=auto' -Naur a/src/global/mail_params.h b/src/global/mail_params.h
--- a/src/global/mail_params.h	2024-01-05 17:01:47.158923914 +0100
+++ b/src/global/mail_params.h	2024-01-05 17:01:49.880884276 +0100
@@ -2916,7 +2916,7 @@
 extern char *var_verify_service;
 
 #define VAR_VERIFY_MAP			"address_verify_map"
-#define DEF_VERIFY_MAP			"btree:$data_directory/verify_cache"
+#define DEF_VERIFY_MAP			"lmdb:$data_directory/verify_cache"
 extern char *var_verify_map;
 
 #define VAR_VERIFY_POS_EXP		"address_verify_positive_expire_time"
@@ -3728,7 +3728,7 @@
   * postscreen(8)
   */
 #define VAR_PSC_CACHE_MAP	"postscreen_cache_map"
-#define DEF_PSC_CACHE_MAP	"btree:$data_directory/postscreen_cache"
+#define DEF_PSC_CACHE_MAP	"lmdb:$data_directory/postscreen_cache"
 extern char *var_psc_cache_map;
 
 #define VAR_SMTPD_SERVICE	"smtpd_service_name"
