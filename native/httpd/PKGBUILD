targets=(
  "centos"
  "ubuntu"
)
pkgname="carbonio-httpd"
pkgver="2.4.48"
pkgrel="1"
pkgdesc="A high performance Unix-based HTTP server"
pkgdesclong=(
  "A high performance Unix-based HTTP server"
)
arch="amd64"
maintainer="Zextras <packages@zextras.com"
url="https://zextras.com"
depends:apt=(
  "libjansson4"
  "libpcre3"
  "carbonio-apache-base"
  "carbonio-apr-util"
  "carbonio-libxml2"
  "carbonio-openssl"
  "zlib1g"
)
makedepends:apt=(
  "curl"
  "libjansson-dev"
  "libpcre3-dev"
  "zlib1g-dev"
)
depends:yum=(
  "jansson"
  "pcre"
  "carbonio-apache-base"
  "carbonio-apr-util"
  "carbonio-libxml2"
  "carbonio-openssl"
  "zlib"
)
makedepends:yum=(
  "curl"
  "jansson-devel"
  "pcre-devel"
  "zlib-devel"
)
section="utils"
priority="optional"
sources=(
  "https://www.apache.org/dist/httpd/httpd-${pkgver}.tar.bz2"
)
hashsums=(
  "1bc826e7b2e88108c7e4bf43c026636f77a41d849cfb667aa7b5c0b86dbf966c"
)

build() {
  cd "${srcdir}/httpd-${pkgver}"
  export LDFLAGS="-Wl,-rpath,/opt/zextras/common/lib"
  export CFLAGS="-O2 -I/opt/zextras/common/include"

  ./configure --prefix=/opt/zextras/common \
    --with-apr=/opt/zextras/common/bin/apr-1-config \
    --with-apr-util=/opt/zextras/common/bin/apu-1-config \
    --mandir=/opt/zextras/common/share/man \
    --libexecdir=/opt/zextras/common/lib/apache2/modules \
    --datadir=/opt/zextras/data/httpd \
    --with-mpm=event \
    --enable-mpms-shared=all \
    --enable-so \
    --enable-authnz-fcgi \
    --enable-cache --enable-disk-cache --enable-mem-cache --enable-file-cache \
    --enable-deflate --enable-cgi --enable-cgid \
    --enable-proxy --enable-proxy-connect \
    --enable-proxy-http --enable-proxy-ftp \
    --enable-dbd --enable-imagemap --enable-ident --enable-cern-meta \
    --with-libxml2=/opt/zextras/common --enable-xml2enc \
    --with-ssl=/opt/zextras/common --enable-ssl
    # --enable-http2 --enable-proxy-http2 \
    # --enable-brotli \
    # --enable-ldap --enable-authnz-ldap 


  make -j16
}

package() {
  cd "${srcdir}/httpd-${pkgver}"
  make DESTDIR="${pkgdir}" install
  mkdir -p "${pkgdir}"/opt/zextras/data/httpd/conf
  mv "${pkgdir}"/opt/zextras/common/conf/mime.types \
    "${pkgdir}"/opt/zextras/data/httpd/conf/
  mv "${pkgdir}"/opt/zextras/common/conf/magic \
    "${pkgdir}"/opt/zextras/data/httpd/conf/
}
