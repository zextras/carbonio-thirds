targets=(
  "centos"
  "ubuntu"
)
pkgname="carbonio-cyrus-sasl"
pkgver="2.1.27"
pkgrel="1"
pkgdesc="Cyrus Simple Authentication Service Layer (SASL) library"
pkgdesclong=(
  "Cyrus Simple Authentication Service Layer (SASL) library"
)
arch="amd64"
maintainer="Zextras <packages@zextras.com"
url="https://zextras.com"
depends:apt=(
  "carbonio-krb5"
  "carbonio-openssl"
  "zlib1g"
)
makedepends:apt=(
  "groff-base"
  "zlib1g-dev"
)
depends:yum=(
  "carbonio-krb5"
  "carbonio-openssl"
  "zlib"
)
makedepends:yum=(
  "groff-base"
  "zlib-devel"
)
section="utils"
priority="optional"
sources=(
  "https://github.com/cyrusimap/cyrus-sasl/releases/download/cyrus-sasl-${pkgver}/cyrus-sasl-${pkgver}.tar.gz"
  "0006-Enable-autoconf-maintainer-mode.patch"
  "0010-Update-required-libraries-when-ld-as-needed-is-used.patch"
  "0013-Don-t-use-la-files-for-opening-plugins.patch"
  "0020-Restore-LIBS-after-checking-gss_inquire_sec_context_.patch"
  "0022-Fix-keytab-option-for-MIT-Kerberos.patch"
  "0032-Add-with_pgsql-include-postgresql-to-include-path.patch"
  "gdbm-errno.patch"
  "zm_auth.patch"
)
hashsums=(
  "26866b1549b00ffd020f188a43c258017fa1c382b3ddadd8201536f72efb05d5"
  "7bd2b2af36c061e92f69944a18e2c122aea0d2b21773f5ea47bb6209f13d0812"
  "8e22cb6ac58208f191b1eb19aac602c1bf49708f2a3b2e3de5f5b2c1e2467906"
  "bbee401c01dc6942710e0c1285091fcd98588bf636b52f24ed0e3b04039b748b"
  "a953c79c585d579f25135de0fe807d6da1fddccbd5b66a9606fb6390c12c7e31"
  "1a0ae7bd722d57feb6fab12c05eb1922982c68bd9be1c165d405954012e6634f"
  "3c375f8755fdbd98a21c4ee195bebbd2a146901fee327e4dd6cfde7a4dcba7c3"
  "03a57cbcec85602fb8e39b7c8a3ff1a22d2c20a28e771b8b326a570d733bf432"
  "870f04b5d9e6d2a37baafd0e0bb0c1c7a57483e4988e2e3517f4ceefb76557a6"
)

build() {
  cd "${srcdir}/cyrus-sasl-${pkgver}"
  patch -Np1 -i ../0006-Enable-autoconf-maintainer-mode.patch
  patch -Np1 -i ../0010-Update-required-libraries-when-ld-as-needed-is-used.patch
  patch -Np1 -i ../0013-Don-t-use-la-files-for-opening-plugins.patch
  patch -Np1 -i ../0020-Restore-LIBS-after-checking-gss_inquire_sec_context_.patch
  patch -Np1 -i ../0022-Fix-keytab-option-for-MIT-Kerberos.patch
  patch -Np1 -i ../0032-Add-with_pgsql-include-postgresql-to-include-path.patch
  patch -Np1 -i ../gdbm-errno.patch
  patch -Np1 -i ../zm_auth.patch
  export LDFLAGS="-Wl,-rpath,/opt/zextras/common/lib -L/opt/zextras/common/lib -lxml2"
  export CFLAGS="-D_REENTRANT -Wno-error -I/opt/zextras/common/include -I/opt/zextras/common/include/libxml2"
  export CPPFLAGS="-D_REENTRANT -Wno-error -I/opt/zextras/common/include"

  rm -f config/config.guess config/config.sub 
  rm -f config/ltconfig config/ltmain.sh config/libtool.m4
  rm -f saslauthd/config/ltconfig
  rm -fr autom4te.cache
	libtoolize -f -c
	aclocal -I config -I m4
	automake -a -c -f
	autoheader
	autoconf -f
  sed -i.bak 's/-lRSAglue //' configure
  ./configure --prefix=/opt/zextras/common \
      --enable-static=no \
      --enable-shared \
      --enable-alwaystrue \
      --enable-checkapop \
      --enable-cram \
      --enable-digest \
      --disable-otp \
      --disable-srp \
      --disable-srp-setpass \
      --disable-krb4 \
      --with-gss_impl=mit \
      --enable-gssapi \
      --enable-auth-sasldb \
      --enable-plain \
      --enable-anon \
      --enable-login \
      --enable-ntlm \
      --disable-passdss \
      --enable-sql \
      --enable-zimbra \
      --without-pgsql \
      --with-mysql=/opt/zextras/common \
      --disable-macos-framework \
      --with-saslauthd=/opt/zextras/data/sasl2/state \
      --with-plugindir=/opt/zextras/common/lib/sasl2 \
      --with-lib-subdir=lib \
      --with-openssl=/opt/zextras/common \
      --with-dblib=no \
      --with-configdir=/opt/zextras/conf/sasl2 \
      --with-devrandom=/dev/urandom
  sed -i -e 's/ -shared / -Wl,-O1,--as-needed\0/g' libtool
  make -j16
}

package() {
  cd "${srcdir}/cyrus-sasl-${pkgver}"
  make DESTDIR="${pkgdir}" install

  find "${pkgdir}" -name '*.a' -delete
  find "${pkgdir}" -name '*.la' -delete
}
