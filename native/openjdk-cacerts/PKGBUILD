targets=(
  "centos"
  "ubuntu"
)
pkgname="carbonio-openjdk-cacerts"
pkgver="1.0.6"
pkgrel="2"
pkgdesc="CA Certs keystore for OpenJDK"
pkgdesclong=(
  "CA Certs keystore for OpenJDK"
)
arch="amd64"
maintainer="Zextras <packages@zextras.com"
url="https:/zextras.com"
depends=(
  "carbonio-openjdk"
)
section="utils"
priority="optional"
sources=(
  "https://hg.mozilla.org/projects/nss/raw-file/7554fb4e12af7abf01983826b4f8e12946661558/lib/ckfw/builtins/certdata.txt"
  "import-cacerts"
)
hashsums=(
  "187ef9dc231135324fe78830cf4462f1ecdeab3e6c9d5e38d623391e88dc5d3c"
  "00b2547118007f255c87b3fd3c2a9ccd855a9a6e69c6faff442ad5d05f7cf5d8"
)

package() {
  mkdir -p "${pkgdir}/opt/zextras/common/etc/java"

  cd "${srcdir}"
  ./import-cacerts -f certdata.txt -o \
    "${pkgdir}"/opt/zextras/common/etc/java
}

preinst:apt() {
  if [ "$1" = upgrade ]; then
      mkdir -p /opt/zextras/.saveconfig/carbonio-openjdk-cacerts
      cacerts=$(mktemp --tmpdir=/opt/zextras/.saveconfig/carbonio-openjdk-cacerts cacerts.XXXXXX 2>/dev/null)
      cp /opt/zextras/common/etc/java/cacerts $cacerts
  fi
  exit 0
}

postinst:apt() {
  if [ "$1" = configure ]; then
    # creating zextras group if it isn't already there
    if ! getent group zextras >/dev/null; then
      addgroup --system --force-badname --quiet zextras
    fi

    # creating zextras user if it isn't already there
    if ! getent passwd zextras >/dev/null; then
      adduser --system --force-badname --quiet \
        --ingroup zextras \
        --home /opt/zextras \
        --shell /bin/bash \
        zextras
      usermod -c "zextras user" zextras
    fi

    if ! test -d /opt/zextras/conf/ca; then
      mkdir /opt/zextras/conf/ca
      chown -R zextras:zextras /opt/zextras/conf/ca
    fi

    chown zextras:zextras /opt/zextras/common/etc/java/cacerts
    chmod 644 /opt/zextras/common/etc/java/cacerts
    if [ "${2%%-*}" != "" ]; then
      if [ -x /opt/zextras/bin/zmcertmgr ]; then
        # Run as zextras, extract CA to /opt/zextras/conf/ca
        su - zextras -c '/opt/zextras/bin/zmcertmgr createca'
        # Run as zextras, update OpenJDK cacerts file with the CA stored in LDAP
        su - zextras -c '/opt/zextras/bin/zmcertmgr deployca --localonly'
        for dir in /opt/zextras/.saveconfig/carbonio-openjdk-cacerts-${2%%-*}; do
          if [ -d "$dir" ]; then
            chown zextras:zextras $dir/cacerts.*
            chmod 644 $dir/cacerts.*
            for cert in $(/opt/zextras/common/bin/keytool -list -keystore $dir/cacerts.* -storepass changeit | grep trustedCertEntry | grep -v 'openjdk-cacerts/build/ubuntu' | grep -v 'tmp/rhel' | grep -Eo "^[^,]*"); do
              /opt/zextras/common/bin/keytool -exportcert -keystore $dir/cacerts.* -storepass changeit -alias $cert -file $dir/${cert}.crt
              chown zextras:zextras $dir/${cert}.crt
              su - zextras -c "/opt/zextras/bin/zmcertmgr addcacert $dir/${cert}.crt"
            done
          fi
        done
      fi
    fi
  fi
  exit 0
}

preinst:yum() {
  if [ "$1" -ge "2" ]; then
    mkdir -p /opt/zextras/.saveconfig/carbonio-openjdk-cacerts
    cacerts=$(mktemp --tmpdir=/opt/zextras/.saveconfig/carbonio-openjdk-cacerts cacerts.XXXXXX)
    cp /opt/zextras/common/etc/java/cacerts $cacerts
  fi
}

postinst:yum() {
  # creating zextras group if it isn't already there
  if ! getent group zextras >/dev/null; then
    addgroup --system --force-badname --quiet zextras
  fi
  # creating zextras user if it isn't already there
  if ! getent passwd zextras >/dev/null; then
    adduser --system --force-badname --quiet \
      --ingroup zextras \
      --home /opt/zextras \
      --shell /bin/bash \
      zextras
    usermod -c "zextras user" zextras
  fi

  if ! test -d /opt/zextras/conf/ca; then
    mkdir /opt/zextras/conf/ca
    chown -R zextras:zextras /opt/zextras/conf/ca
  fi

  chown zextras:zextras /opt/zextras/common/etc/java/cacerts
  chmod 644 /opt/zextras/common/etc/java/cacerts
  if [ "$1" -ge "2" ]; then
    if [ -x /opt/zextras/bin/zmcertmgr ]; then
      # Run as zextras, extract CA to /opt/zextras/conf/ca
      su - zextras -c '/opt/zextras/bin/zmcertmgr createca'
      # Run as zextras, update OpenJDK cacerts file with the CA stored in LDAP
      su - zextras -c '/opt/zextras/bin/zmcertmgr deployca --localonly'
      for dir in /opt/zextras/.saveconfig/carbonio-openjdk-cacerts; do
        if [ -d "$dir" ]; then
          chown zextras:zextras $dir/cacerts.*
          chmod 644 $dir/cacerts.*
          for cert in $(/opt/zextras/common/bin/keytool -list -keystore $dir/cacerts.* -storepass changeit | grep trustedCertEntry | grep -v 'openjdk-cacerts/build/ubuntu' | grep -v 'tmp/rhel' | grep -v 'openjdk-cacerts/build/rhel' | grep -Eo "^[^,]*"); do
            /opt/zextras/common/bin/keytool -exportcert -keystore $dir/cacerts.* -storepass changeit -alias $cert -file $dir/${cert}.crt
            chown zextras:zextras $dir/${cert}.crt
            su - zextras -c "/opt/zextras/bin/zmcertmgr addcacert $dir/${cert}.crt"
          done
        fi
      done
    fi
  fi
}
