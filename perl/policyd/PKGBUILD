pkgname="carbonio-policyd"
pkgver="2.1.0.0"
pkgrel="5"
pkgdesc="Multi-platform policy server for popular MTAs (aka ClueBringer)"
arch=('x86_64')
maintainer="Zextras <packages@zextras.com>"
url="https://github.com/zextras"
license=('GPL-2.0-or-later')
depends__apt=(
  "carbonio-perl-cache-fastmmap"
  "carbonio-perl-config-inifiles"
  "carbonio-perl-dbd-sqlite"
  "carbonio-perl-dbi"
  "carbonio-perl-mail-spf"
  "carbonio-perl-net-cidr"
  "carbonio-perl-net-dns"
  "carbonio-perl-net-server"
  "carbonio-perl-timedate"
  "libsocket6-perl"
  "perl"
)
depends__yum=(
  "carbonio-perl-cache-fastmmap"
  "carbonio-perl-config-inifiles"
  "carbonio-perl-dbd-sqlite"
  "carbonio-perl-dbi"
  "carbonio-perl-mail-spf"
  "carbonio-perl-net-cidr"
  "carbonio-perl-net-dns"
  "carbonio-perl-net-server"
  "carbonio-perl-timedate"
  "perl-core"
  "perl-Socket6"
  "perl"
)
makedepends=(
  "git"
)
section="libs"
priority="important"
source=(
  "git+https://gitlab.linux.community/policyd/policyd"
  "${pkgname}.patch"
  "${pkgname}.service"
  "systemd-tmpfile.conf"
)
sha256sums=(
  'SKIP'
  '2f71d4274585f8ae963e2e2b081a0b0d0780e9eb7aa0e44cd99b5b7f3271119f'
  '4ed43da17216bb25cd0b2defc6c3f7ee500a60baeaeda1190870a5b8d11dfa9a'
  '10734c3340cdc7cf75606449ebe3ab7a5779950d6d61d1e7adfca3b511d32efa'
)

_package() {
  cd "${srcdir}/policyd"
  git reset --hard cf484f1b93cf9965886cc89d33bdeee9c26426cb

  ./update-git-modules
  rm -rf .git awitpt/.git
  rm -rf awitpt/CPAN* awitpt/doxygen awitpt/SOAP
  mv -f awitpt/awitpt/db awitpt/
  mv -f awitpt/awitpt/cache.pm awitpt/
  mv -f awitpt/awitpt/netip.pm awitpt/
  rm -rf awitpt/awitpt
  rm -rf debian

  # carbonio custom patch for policyd
  patch -Np1 -i "${srcdir}/carbonio-policyd.patch"

  # executables
  mkdir -p "${pkgdir}/opt/zextras/common/bin"
  cp cbpadmin "${pkgdir}/opt/zextras/common/bin"
  cp cbpolicyd "${pkgdir}/opt/zextras/common/bin"

  # libs
  mkdir -p "${pkgdir}/opt/zextras/common/lib/policyd-2.1"
  cp -r cbp "${pkgdir}/opt/zextras/common/lib/policyd-2.1"
  cp -r awitpt "${pkgdir}/opt/zextras/common/lib/policyd-2.1"

  mkdir -p "${pkgdir}/opt/zextras/common/share"
  cp -r contrib "${pkgdir}/opt/zextras/common/share"
  cp -r database "${pkgdir}/opt/zextras/common/share"
  cp -r webui "${pkgdir}/opt/zextras/common/share"

  # systemd tmpfiles.d configuration
  install -Dm644 "${srcdir}/systemd-tmpfile.conf" \
    "${pkgdir}/usr/lib/tmpfiles.d/${pkgname}.conf"
}

_package_systemd() {
  # systemd units
  install -Dm644 "${srcdir}/${pkgname}.service" \
    "${pkgdir}/usr/lib/systemd/system/${pkgname}.service"
}

_postinst() {
  # creating zextras group if it isn't already there
  getent group zextras >/dev/null \
    || groupadd -r zextras
  # creating zextras user if it isn't already there
  getent passwd zextras >/dev/null \
    || useradd -r -g zextras -d /opt/zextras -s /bin/bash -c "zextras user" zextras
}

package() {
  _package
  _package_systemd
}

package__rocky_8() {
  _package
}

package__rocky_9() {
  _package
  _package_systemd
}

package__ubuntu_jammy() {
  _package
}

package__ubuntu_noble() {
  _package
  _package_systemd
}

postinst__apt() {
  if [ "$1" = "configure" ]; then
    _postinst
  fi

  systemd-tmpfiles --create /usr/lib/tmpfiles.d/carbonio-policyd.conf || :
}

postinst__yum() {
  _postinst

  systemd-tmpfiles --create /usr/lib/tmpfiles.d/carbonio-policyd.conf || :
}
