pkgname="carbonio-openjdk-cacerts"
pkgver="3.98"
pkgrel="2"
pkgdesc="CA Certs keystore for OpenJDK"
arch=('x86_64')
maintainer="Zextras <packages@zextras.com>"
url="https:/zextras.com"
depends=(
  "carbonio-openjdk"
)
section="utils"
priority="optional"
source=(
  "https://raw.githubusercontent.com/nss-dev/nss/NSS_${pkgver/./_}_RTM/lib/ckfw/builtins/certdata.txt"
  "import-cacerts"
)
sha256sums=('4d96bd539f4719e9ace493757afbe4a23ee8579de1c97fbebc50bba3c12e8c1e'
  '24babc85aeb1f5af9a7bf0af2bd4d299609039bda9862356064aaa92542d662f')

package() {
  mkdir -p "${pkgdir}/opt/zextras/common/etc/java"

  cd "${srcdir}"

  # Convert certdata.txt to PKCS12 der certificates compatible with
  # OpenJDK keystore
  ./import-cacerts -f certdata.txt -o \
    "${pkgdir}"/opt/zextras/common/etc/java
}

preinst__apt() {
  if [ "$1" = upgrade ]; then
    if [ "$2" != "$3" ]; then
      cacerts_save_dir="/opt/zextras/.saveconfig/carbonio-openjdk-cacerts"
      if [ ! -d "${cacerts_save_dir}" ]; then
        mkdir -p "${cacerts_save_dir}"
      fi
      cacerts_backup=${cacerts_save_dir}/cacerts-$(date +"%Y%m%d")

      cp /opt/zextras/common/etc/java/cacerts "$cacerts_backup"

      # Marker file to indicate in postinstall that an update was done
      touch /opt/zextras/common/etc/java/.upgrade
    fi
  fi
}

preinst__yum() {
  if [ "$1" == "2" ]; then
    cacerts_save_dir="/opt/zextras/.saveconfig/carbonio-openjdk-cacerts"
    if [ ! -d "${cacerts_save_dir}" ]; then
      mkdir -p "${cacerts_save_dir}"
    fi
    cacerts_backup=${cacerts_save_dir}/cacerts-$(date +"%Y%m%d")

    cp /opt/zextras/common/etc/java/cacerts "$cacerts_backup"

    # Marker file to indicate in postinstall that an update was done
    touch /opt/zextras/common/etc/java/.upgrade
  fi
}

postinst__apt() {
  if [ "$1" = "configure" ]; then
    # creating zextras group if it isn't already there
    if ! getent group zextras >/dev/null; then
      addgroup --system --force-badname --quiet zextras
    fi

    # creating zextras user if it isn't already there
    if ! getent passwd zextras >/dev/null; then
      adduser --system --force-badname --quiet \
        --ingroup zextras \
        --home /opt/zextras \
        --shell /bin/bash \
        zextras
      usermod -c "zextras user" zextras
    fi
  fi

  chown zextras:zextras /opt/zextras/common/etc/java/cacerts
  chmod 644 /opt/zextras/common/etc/java/cacerts

  if [ -f /opt/zextras/common/etc/java/.upgrade ]; then
    rm -f /opt/zextras/common/etc/java/.upgrade

    cacerts_save_dir="/opt/zextras/.saveconfig/carbonio-openjdk-cacerts"
    cacerts_backup=${cacerts_save_dir}/cacerts-$(date +"%Y%m%d")

    mailboxd_truststore_password=$(su - zextras -c "zmlocalconfig -s -m nokey mailboxd_truststore_password")
    if [ -x /opt/zextras/bin/zmcertmgr ]; then
      # Extract CA to /opt/zimbra/conf/ca
      su - zextras -c '/opt/zextras/bin/zmcertmgr createca'
      # Update OpenJDK cacerts file with the CA stored in LDAP
      su - zextras -c '/opt/zextras/bin/zmcertmgr deployca --localonly'

      if [ "$mailboxd_truststore_password" != "changeit" ]; then
        su - zextras -c "/opt/zextras/common/bin/keytool -storepasswd -keystore /opt/zextras/common/etc/java/cacerts -storepass changeit -new $mailboxd_truststore_password"
      fi

      if [ -d "$cacerts_save_dir" ]; then
        chown zextras:zextras "$cacerts_backup"
        chmod 644 "$cacerts_backup"

        echo "Restoring certificates after upgrades from latest backup:"
        echo "$cacerts_backup"
        echo "please wait..."

        for cert in $(/opt/zextras/common/bin/keytool -list -keystore "$cacerts_backup" -storepass changeit | grep trustedCertEntry | grep -Eo "^[^,]*"); do
          /opt/zextras/common/bin/keytool \
            -exportcert \
            -keystore "$cacerts_backup" \
            -storepass changeit \
            -alias "$cert" \
            -file "$cacerts_save_dir/$cert" 2>/dev/null

          chown zextras:zextras "$cacerts_save_dir/$cert"
          su - zextras -c "/opt/zextras/bin/zmcertmgr addcacert $cacerts_save_dir/$cert" >/dev/null
        done
      fi
    fi
  fi
}

postinst__yum() {
  # creating zextras group if it isn't already there
  if ! getent group zextras >/dev/null; then
    groupadd --system zextras >/dev/null
  fi

  # creating zextras user if it isn't already there
  if ! getent passwd zextras >/dev/null; then
    useradd --system \
      -g zextras \
      -d /opt/zextras \
      --shell /bin/bash \
      zextras >/dev/null
    usermod -c "zextras user" zextras
  fi

  chown zextras:zextras /opt/zextras/common/etc/java/cacerts
  chmod 644 /opt/zextras/common/etc/java/cacerts

  if [ -f /opt/zextras/common/etc/java/.upgrade ]; then
    rm -f /opt/zextras/common/etc/java/.upgrade

    cacerts_save_dir="/opt/zextras/.saveconfig/carbonio-openjdk-cacerts"
    cacerts_backup=${cacerts_save_dir}/cacerts-$(date +"%Y%m%d")

    mailboxd_truststore_password=$(su - zextras -c "zmlocalconfig -s -m nokey mailboxd_truststore_password")
    if [ -x /opt/zextras/bin/zmcertmgr ]; then
      # Extract CA to /opt/zimbra/conf/ca
      su - zextras -c '/opt/zextras/bin/zmcertmgr createca'
      # Update OpenJDK cacerts file with the CA stored in LDAP
      su - zextras -c '/opt/zextras/bin/zmcertmgr deployca --localonly'

      if [ "$mailboxd_truststore_password" != "changeit" ]; then
        su - zextras -c "/opt/zextras/common/bin/keytool -storepasswd -keystore /opt/zextras/common/etc/java/cacerts -storepass changeit -new $mailboxd_truststore_password"
      fi

      if [ -d "$cacerts_save_dir" ]; then
        chown zextras:zextras "$cacerts_backup"
        chmod 644 "$cacerts_backup"

        echo "Restoring certificates after upgrades from latest backup:"
        echo "$cacerts_backup"
        echo "please wait..."

        for cert in $(/opt/zextras/common/bin/keytool -list -keystore "$cacerts_backup" -storepass changeit | grep trustedCertEntry | grep -Eo "^[^,]*"); do
          /opt/zextras/common/bin/keytool \
            -exportcert \
            -keystore "$cacerts_backup" \
            -storepass changeit \
            -alias "$cert" \
            -file "$cacerts_save_dir/$cert" 2>/dev/null

          chown zextras:zextras "$cacerts_save_dir/$cert"
          su - zextras -c "/opt/zextras/bin/zmcertmgr addcacert $cacerts_save_dir/$cert" >/dev/null
        done
      fi
    fi
  fi
}
